<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>–ù–∞–≤—ñ–≥–∞—Ü—ñ—è –º–∞—Ä—à—Ä—É—Ç–æ–º</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <!-- Turf.js –¥–ª—è –≥–µ–æ-–æ–±—á–∏—Å–ª–µ–Ω—å -->
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <!-- (–ù–µ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ) Firebase ‚Äî —è–∫—â–æ —Ö–æ—á–µ—à —Ç—è–≥–Ω—É—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –ø–æ rid –∑ Firestore -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    :root { --card:#fff; --line:#e5e7eb; --muted:#6b7280; --accent:#2563eb; }
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #map { position:fixed; inset:0; }
    .topbar { position:fixed; left:0; right:0; top:0; height:64px; display:flex; align-items:center; gap:12px; padding:8px 12px; background:rgba(255,255,255,.85); backdrop-filter: blur(8px); box-shadow:0 1px 0 var(--line); z-index:10; }
    .title { font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .stats { display:flex; gap:8px; font-size:14px; color:#111; }
    .pill { background:#f3f4f6; border:1px solid var(--line); padding:4px 8px; border-radius:999px; }
    .controls { margin-left:auto; display:flex; gap:8px; }
    button { height:40px; padding:0 12px; border-radius:10px; border:1px solid var(--line); background:var(--card); cursor:pointer; font-weight:600; }
    .primary { background:var(--accent); color:#fff; border-color:#1d4ed8; }
    .fab { position:fixed; right:12px; bottom:12px; z-index:10; display:flex; flex-direction:column; gap:8px; }
    .fab button { background:#fff; width:48px; height:48px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.15); border:1px solid var(--line); }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:24px; background:#111; color:#fff; padding:10px 14px; border-radius:10px; display:none; z-index:20; }
    .notice { position:fixed; left:12px; right:12px; bottom:12px; background:rgba(17,24,39,.9); color:#fff; padding:8px 12px; border-radius:12px; font-size:13px; line-height:1.35; display:none; z-index:20; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="topbar">
    <div class="title" id="routeTitle">–ù–∞–≤—ñ–≥–∞—Ü—ñ—è</div>
    <div class="stats">
      <div class="pill" id="statDistance">‚Äî –∫–º</div>
      <div class="pill" id="statEta">ETA ‚Äî</div>
      <div class="pill" id="statMode">driving</div>
    </div>
    <div class="controls">
      <button id="btnStart" class="primary">–°—Ç–∞—Ä—Ç</button>
      <button id="btnStop">–°—Ç–æ–ø</button>
      <button id="btnShare">–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è</button>
    </div>
  </div>

  <div class="fab">
    <button id="btnRecenter" title="–¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏">üìç</button>
  </div>

  <div class="toast" id="toast">–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ</div>
  <div class="notice" id="notice">–î–ª—è –≥–æ–ª–æ—Å–æ–≤–∏—Ö –ø—ñ–¥–∫–∞–∑–æ–∫ –∑–∞–ª–∏—à–∞–π —Ü—é —Å—Ç–æ—Ä—ñ–Ω–∫—É –≤—ñ–¥–∫—Ä–∏—Ç–æ—é –Ω–∞ –µ–∫—Ä–∞–Ω—ñ. –£ —Ñ–æ–Ω–æ–≤–æ–º—É —Ä–µ–∂–∏–º—ñ –±—Ä–∞—É–∑–µ—Ä –º–æ–∂–µ –∑—É–ø–∏–Ω—è—Ç–∏ GPS/–∑–≤—É–∫.</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const MAPBOX_TOKEN = qs.get('token') || window.MAPBOX_TOKEN || 'pk.eyJ1IjoidGtjaGsiLCJhIjoiY21keTN0bXVlMjN6djJrczZ2NDk5bXRoMiJ9.6n1kuiUJ3EdGUpz5I6-wdg';
  const PROFILE = qs.get('profile') || 'driving'; // driving, driving-traffic, walking, cycling
  const SRC_B64 = qs.get('src'); // base64 –º–∞—Ä—à—Ä—É—Ç—É {name, points:[[lon,lat],...]}
  const ROUTE_ID = qs.get('rid'); // —è–∫—â–æ —Ö–æ—á–µ—à —Ç—è–≥–Ω—É—Ç–∏ –∑ Firestore –∑–∞ id
  const AUTO_START = qs.get('autostart') === '1';

  // === UTF‚Äë8 Base64 helpers ===
  function b64decodeUtf8(b64){
    const bin = atob(b64);
    const bytes = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
    return new TextDecoder().decode(bytes);
  }
  function b64encodeUtf8(objOrString){
    const s = typeof objOrString === 'string' ? objOrString : JSON.stringify(objOrString);
    const bytes = new TextEncoder().encode(s);
    let bin = '';
    for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
    return btoa(bin);
  }

  mapboxgl.accessToken = MAPBOX_TOKEN;

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [30.523, 50.45],
    zoom: 12,
    pitch: 45,
    attributionControl: true
  });
  map.addControl(new mapboxgl.NavigationControl({visualizePitch:true}), 'bottom-left');

  // UI
  document.getElementById('statMode').textContent = PROFILE;
  const $title = document.getElementById('routeTitle');
  const $dist = document.getElementById('statDistance');
  const $eta = document.getElementById('statEta');
  const $toast = document.getElementById('toast');
  const $notice = document.getElementById('notice');

  let routeGeoJSON = null;    // LineString –∑ Directions API
  let steps = [];             // –∫—Ä–æ–∫–∏ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π
  let totalDistance = 0;      // –º
  let totalDuration = 0;      // —Å
  let watchId = null;         // –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—è
  let userMarker = null;      // –º–∞—Ä–∫–µ—Ä –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  let lastUserPos = null;     // –¥–ª—è –∞–∑–∏–º—É—Ç–∞
  let spokenStepIndex = -1;   // —â–æ –≤–∂–µ –æ–∑–≤—É—á–∏–ª–∏

  function speak(text){
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'uk-UA';
      speechSynthesis.speak(u);
    }catch(e){ /* ignore */ }
  }

  function showToast(msg){ $toast.textContent = msg; $toast.style.display='block'; setTimeout(()=>{$toast.style.display='none'}, 1300); }

  function metersToKM(m){ return (m/1000).toFixed(1); }
  function secondsToETA(s){
    const dt = new Date(Date.now() + s*1000);
    const hh = String(dt.getHours()).padStart(2,'0');
    const mm = String(dt.getMinutes()).padStart(2,'0');
    return `${hh}:${mm}`;
  }

  async function loadRouteData(){
    if (SRC_B64){
      const json = JSON.parse(b64decodeUtf8(SRC_B64)); // UTF‚Äë8 –¥–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è
      return { name: json.name || '–ú–∞—Ä—à—Ä—É—Ç', points: json.points };
    }
    if (ROUTE_ID){
      try{
        // –û—á—ñ–∫—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É window.firebaseConfig. –Ø–∫—â–æ —ó—ó –Ω–µ–º–∞—î ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏–º–æ.
        if (!window.firebaseConfig) throw new Error('Missing firebaseConfig');
        const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(window.firebaseConfig);
        const db = firebase.firestore(app);
        const doc = await db.collection('routes').doc(ROUTE_ID).get();
        if (!doc.exists) throw new Error('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
        const data = doc.data();
        return { name: data.name || `Route ${ROUTE_ID}`, points: data.points };
      }catch(e){ alert('–ù–µ –≤–¥–∞–ª–æ—Å—å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç: '+e.message); throw e; }
    }
    throw new Error('–ù–µ –ø–µ—Ä–µ–¥–∞–Ω–æ –º–∞—Ä—à—Ä—É—Ç. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π ?src=... –∞–±–æ ?rid=...');
  }

  async function fetchDirections(points){
    // –§–æ—Ä–º—É—î–º–æ –∑–∞–ø–∏—Ç –¥–æ Directions API
    const coords = points.map(p => p.join(',')).join(';');
    const url = `https://api.mapbox.com/directions/v5/mapbox/${PROFILE}/${coords}?alternatives=false&geometries=geojson&overview=full&steps=true&access_token=${MAPBOX_TOKEN}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Directions API error');
    const json = await res.json();
    if (!json.routes || !json.routes[0]) throw new Error('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –ø–æ–±—É–¥–æ–≤–∞–Ω–æ');
    const r = json.routes[0];
    routeGeoJSON = { type:'Feature', geometry:r.geometry, properties:{} };
    steps = r.legs.flatMap(l=>l.steps);
    totalDistance = r.distance; // meters
    totalDuration = r.duration; // seconds
    $dist.textContent = `${metersToKM(totalDistance)} –∫–º`;
    $eta.textContent = `ETA ${secondsToETA(totalDuration)}`;
    return routeGeoJSON;
  }

  function addRouteToMap(){
    if (!routeGeoJSON) return;
    if (map.getSource('route')){
      map.getSource('route').setData(routeGeoJSON);
    } else {
      map.addSource('route', { type:'geojson', data: routeGeoJSON });
      map.addLayer({ id:'route-line', type:'line', source:'route', paint:{ 'line-width':6, 'line-color':'#1d4ed8' } });
    }
    const bbox = turf.bbox(routeGeoJSON);
    map.fitBounds(bbox, { padding:{top:80, right:20, bottom:20, left:20} });
  }

  function ensureUserMarker(lng, lat, heading){
    if (!userMarker){
      const el = document.createElement('div');
      el.style.width='18px'; el.style.height='18px'; el.style.borderRadius='50%'; el.style.background='#10b981'; el.style.border='2px solid #fff'; el.style.boxShadow='0 0 0 2px rgba(16,185,129,.4)';
      userMarker = new mapboxgl.Marker({element:el, rotationAlignment:'map'})
        .setLngLat([lng, lat]).addTo(map);
    } else {
      userMarker.setLngLat([lng, lat]);
    }
    if (heading!=null && !Number.isNaN(heading)){
      map.rotateTo(heading, {duration:500});
    }
  }

  function computeHeading(prev, curr){
    if (!prev) return null;
    const bearing = turf.bearing(turf.point(prev), turf.point(curr));
    return (bearing+360)%360;
  }

  function onPosition(pos){
    const { longitude:lng, latitude:lat } = pos.coords;
    const curr = [lng,lat];
    const heading = computeHeading(lastUserPos, curr);
    lastUserPos = curr;
    ensureUserMarker(lng, lat, heading);

    // –ü—Ä–∏–≤'—è–∑–∫–∞ –¥–æ –ª—ñ–Ω—ñ—ó –º–∞—Ä—à—Ä—É—Ç—É
    if (routeGeoJSON){
      const snapped = turf.nearestPointOnLine(routeGeoJSON, curr, {units:'meters'});
      const distToLine = snapped.properties.distance; // m

      // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—ñ–¥—Å—Ç–∞–Ω—å –¥–æ —Ñ—ñ–Ω—ñ—à—É
      const line = routeGeoJSON; // Feature<LineString>
      const ls = turf.lineSlice(turf.point(curr), turf.point(routeGeoJSON.geometry.coordinates.at(-1)), line);
      const remain = turf.length(ls, {units:'kilometers'}) * 1000; // m
      $dist.textContent = `${metersToKM(remain)} –∫–º`;

      // –ü–æ—à—É–∫ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∫—Ä–æ–∫—É
      const next = findNextStep(curr);
      if (next && next._remainMeters!=null){
        const etaSec = (next._remainMeters/ totalDistance) * totalDuration;
        $eta.textContent = `ETA ${secondsToETA(etaSec)}`;
        // –û–∑–≤—É—á–∫–∞ –∑–∞ 80–º –¥–æ –º–∞–Ω–µ–≤—Ä—É
        if (next._metersToManeuver < 80 && next._index !== spokenStepIndex){
          const t = stepToSpeech(next);
          speak(t);
          spokenStepIndex = next._index;
        }
      }

      // –ê–≤—Ç–æ—Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è
      if (autoCenter) map.easeTo({ center: curr, duration: 500 });
    }
  }

  function onPositionError(err){ console.warn('GPS error', err); }

  function findNextStep(curr){
    if (!steps || steps.length===0) return null;
    // –ë–µ—Ä–µ–º–æ –Ω–∞–π–±–ª–∏–∂—á–∏–π –∫—Ä–æ–∫, —â–æ –ø–æ–ø–µ—Ä–µ–¥—É
    let best = null; let min = Infinity; let idx = -1;
    steps.forEach((s, i)=>{
      const p = turf.nearestPointOnLine(s.geometry, curr, {units:'meters'});
      const d = p.properties.dist; // –Ω–µ –∑–∞–≤–∂–¥–∏ —î, —Ç–æ–º—É –¥—É–±–ª—é—î–º–æ –Ω–∏–∂—á–µ
      const m = p.properties.distance || d || Infinity; // m –¥–æ –ª—ñ–Ω—ñ—ó –∫—Ä–æ–∫—É
      // –í—ñ–¥—Å—Ç–∞–Ω—å –≤—ñ–¥ —Ç–æ—á–∫–∏ –ø—Ä–æ—î–∫—Ü—ñ—ó –¥–æ –∫—ñ–Ω—Ü—è –∫—Ä–æ–∫—É (—è–∫ –≥—Ä—É–±–∞ –æ—Ü—ñ–Ω–∫–∞)
      const segRemain = turf.length(turf.lineSlice(p, turf.point(s.geometry.coordinates.at(-1)), s.geometry), {units:'kilometers'})*1000;
      const score = m + segRemain; // –ø—Ä–æ—Å—Ç–∏–π —Å–∫–æ—Ä–∏–Ω–≥
      if (score < min){ min = score; best = s; idx = i; best._metersToManeuver = segRemain; }
    });
    if (!best) return null;
    // –ó–∞–ª–∏—à–æ–∫ –º–∞—Ä—à—Ä—É—Ç—É –≤—ñ–¥ –∫—ñ–Ω—Ü—è —Ü—å–æ–≥–æ –∫—Ä–æ–∫—É –¥–æ —Ñ—ñ–Ω—ñ—à—É
    const from = turf.point(best.geometry.coordinates.at(-1));
    const to = turf.point(routeGeoJSON.geometry.coordinates.at(-1));
    const tail = turf.lineSlice(from, to, routeGeoJSON);
    const remainMeters = turf.length(tail, {units:'kilometers'})*1000 + (best._metersToManeuver||0);
    best._remainMeters = remainMeters;
    best._index = idx;
    return best;
  }

  function stepToSpeech(step){
    // –ü—Ä–æ—Å—Ç–µ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó; —É JSON Mapbox —î step.maneuver.instruction –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é
    const man = step.maneuver || {}; const d = Math.round((step.distance||0));
    let text = man.instruction || '';
    // –ü—Ä–æ—Å—Ç–∞ –ª–æ–∫–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–µ—è–∫–∏—Ö —Å–ª—ñ–≤
    text = text.replace(/Turn right/i, '–ü–æ–≤–µ—Ä–Ω—ñ—Ç—å –ø—Ä–∞–≤–æ—Ä—É—á')
               .replace(/Turn left/i, '–ü–æ–≤–µ—Ä–Ω—ñ—Ç—å –ª—ñ–≤–æ—Ä—É—á')
               .replace(/Continue/i, '–†—É—Ö–∞–π—Ç–µ—Å—å –ø—Ä—è–º–æ')
               .replace(/At the roundabout/i, '–ù–∞ –∫–æ–ª—ñ')
               .replace(/Take the exit/i, '–ó º—ó–∂–¥–∂–∞–π—Ç–µ –Ω–∞ –≤–∏—ó–∑–¥');
    if (!/–º|km|–∫–º/.test(text)) text += `. –ó–∞ ${d<1000? d+" –º" : (d/1000).toFixed(1)+" –∫–º"}`;
    return text;
  }

  let autoCenter = true;
  document.getElementById('btnRecenter').onclick = ()=>{ autoCenter = true; if (lastUserPos) map.easeTo({center:lastUserPos, duration:300}); };
  document.getElementById('btnStart').onclick = startNav;
  document.getElementById('btnStop').onclick = stopNav;
  document.getElementById('btnShare').onclick = shareLink;

  function startNav(){
    if (watchId!=null) return;
    if (navigator.geolocation){
      const $notice = document.getElementById('notice');
      $notice.style.display='block';
      watchId = navigator.geolocation.watchPosition(onPosition, onPositionError, { enableHighAccuracy:true, maximumAge:1000, timeout:10000 });
      speak('–ù–∞–≤—ñ–≥–∞—Ü—ñ—é —Ä–æ–∑–ø–æ—á–∞—Ç–æ');
    } else alert('–ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º');
  }
  function stopNav(){ if (watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; speak('–ù–∞–≤—ñ–≥–∞—Ü—ñ—é –∑—É–ø–∏–Ω–µ–Ω–æ'); document.getElementById('notice').style.display='none'; } }

  async function shareLink(){
    if (!routeGeoJSON){ showToast('–ú–∞—Ä—à—Ä—É—Ç —â–µ –Ω–µ –≥–æ—Ç–æ–≤–∏–π'); return; }
    const name = document.getElementById('routeTitle').textContent || '–ú–∞—Ä—à—Ä—É—Ç';
    const points = routeGeoJSON.geometry.coordinates; // –≤–∂–µ —É–∑–≥–æ–¥–∂–µ–Ω—ñ —Ç–æ—á–∫–∏
    const payload = { name, points };
    const b64 = b64encodeUtf8(payload); // UTF‚Äë8 Base64
    const url = `${location.origin}${location.pathname}?src=${encodeURIComponent(b64)}&profile=${PROFILE}&token=${encodeURIComponent(MAPBOX_TOKEN)}&autostart=1`;
    try{
      if (navigator.share){ await navigator.share({ title:name, url }); }
      else { await navigator.clipboard.writeText(url); showToast('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ'); }
    }catch(e){ await navigator.clipboard.writeText(url); showToast('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ'); }
  }

  // –ì–æ–ª–æ–≤–Ω–∏–π –ø–æ—Ç—ñ–∫
  map.on('load', async ()=>{
    try{
      const { name, points } = await loadRouteData();
      document.getElementById('routeTitle').textContent = name;
      await fetchDirections(points);
      addRouteToMap();
      if (AUTO_START) startNav();
    }catch(e){ console.error(e); alert(e.message || e); }
  });
})();
</script>
</body>
</html>
