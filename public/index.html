<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>–ú–∞—Ä—à—Ä—É—Ç–∏ Mapbox</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

  <!-- Firebase (core + firestore, compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <style>
  /* –≤–∏—Å–æ—Ç–∞ —à–∞–ø–∫–∏ (–∑–∞ –ø–æ—Ç—Ä–µ–±–∏ –ø—ñ–¥–∫–æ—Ä–∏–≥—É–π —á–∏—Å–ª–æ) */
  :root { --nav-h: 48px; }

  body { margin:0; padding:0; font-family: sans-serif; }

  /* —à–∞–ø–∫–∞ –∑–≤–µ—Ä—Ö—É –∑–∞–≤–∂–¥–∏ –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–∏ */
  header {
    position: sticky;
    top: 0;
    z-index: 1500;
  }

  /* –ó–°–£–í–ê–Ñ–ú–û –∫–∞—Ä—Ç—É –ù–ò–ñ–ß–ï —à–∞–ø–∫–∏ (–±—É–ª–æ top:0) */
  #map {
    position: absolute;
    top: var(--nav-h);
    bottom: 0;
    width: 100%;
  }

  /* –ü–ê–ù–ï–õ–¨: —Ñ—ñ–∫—Å—É—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —ñ –ø—ñ–¥–Ω—ñ–º–∞—î–º–æ –Ω–∞–¥ canvas */
  #controls{
    position: absolute;
    z-index: 3000;          /* –≤–∏—â–µ –∑–∞ canvas –º–∞–ø–∏ */
    background: white;
    padding: 8px;
    margin: 0;              /* margin –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω */
    top: calc(var(--nav-h) + 8px);
    left: 8px;

    border-radius: 8px; box-shadow: 0 1px 6px rgba(0,0,0,0.25);
    max-width: 360px;       /* –±—É–ª–æ 520 ‚Üí –∫–æ–º–ø–∞–∫—Ç–Ω—ñ—à–µ */
    max-height: 90vh;       /* –Ω–µ –≤–∏—Ö–æ–¥–∏—Ç—å –∑–∞ –µ–∫—Ä–∞–Ω */
    overflow: auto;         /* —Å–∫—Ä–æ–ª —É—Å–µ—Ä–µ–¥–∏–Ω—ñ */
  }

  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
  .btn { margin: 5px 5px 5px 0; padding: 6px 10px; cursor: pointer; }
  .btn.active { background-color: #90ee90; border: 1px solid #4CAF50; }
  input[type="text"], select, textarea { width: 100%; padding: 6px; }
  textarea { min-height: 48px; resize: vertical; }
  small.muted { color:#666; }
  #styleSelector { margin-top: 10px; }
  #dbControls { margin-top: 10px; padding-top:10px; border-top:1px solid #eee;}
  #dbControls input, #dbControls select { margin: 5px 5px 5px 0; padding:6px; }

  #contextMenu {
    position: absolute; background: white; border: 1px solid #ccc; display: none; z-index: 3500;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }
  #contextMenu div { padding: 5px 10px; cursor: pointer; }
  #contextMenu div:hover { background: #eee; }

  /* --- –∫–æ–º–ø–∞–∫—Ç–Ω—ñ—à—ñ –≤—ñ–¥—Å—Ç—É–ø–∏ —Ç–∞ —à—Ä–∏—Ñ—Ç–∏ --- */
  #controls label { font-size: 12.5px; }
  input[type="text"], select, textarea { padding: 3px 6px; font-size: 13.5px; }
  .btn { padding: 3px 8px; font-size: 13.5px; margin: 4px 4px 4px 0; }
  .row { gap: 4px; }

  /* --- –º—ñ–Ω—ñ-—Ä–µ–∂–∏–º –ø–∞–Ω–µ–ª—ñ --- */
  #controls.mini { width: 280px; }
  .mini-bar { display: none; margin-bottom: 6px; gap: 6px; flex-wrap: wrap; }
  #controls.mini .mini-bar { display: flex; }
  #controls.mini .row,
  #controls.mini hr,
  #controls.mini details { display: none; }

  .toggleMini { float: right; margin-left: 6px; }

  /* –¥—Ä—ñ–±–Ω—ñ—à—ñ –ø–æ–ª—è —É —Ä—è–¥–∫—É */
  #controls .row input[type="text"],
  #controls .row select { height: 28px; }

  /* –º—ñ–Ω—ñ-–±–∞—Ä ‚Äî –¥—Ä—ñ–±–Ω—ñ –∫–Ω–æ–ø–∫–∏ */
  .mini-bar .btn { padding: 2px 6px; font-size: 12.5px; }

  /* –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ –ø–∞–Ω–µ–ª—å: —Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ —É –≤—ñ–∫–Ω—ñ */
  .panel-toggle{
    position: fixed;
    z-index: 9999;
    top: 60px;
    left: 6px; /* –±–∞–∑–æ–≤–∞ –ø–æ–∑–∏—Ü—ñ—è; JS –ø–µ—Ä–µ—Å—É–Ω–µ –ø—Ä–∞–≤—ñ—à–µ –ø–∞–Ω–µ–ª—ñ */
    padding: 4px 8px;
  }

  /* –ö–æ–ª–∏ –ø–∞–Ω–µ–ª—å –ø—Ä–∏—Ö–æ–≤–∞–Ω–∞ */
  .controls-hidden #controls{ display:none; }
  .controls-hidden .panel-toggle{ left:10px; }

  /* –û–ü–£–°–¢–ò–¢–ò —à–∞—Ä–∏ Mapbox –Ω–∏–∂—á–µ –∑–∞ –ø–∞–Ω–µ–ª—å (–Ω–∞ –≤–∏–ø–∞–¥–æ–∫ –≤–∏—Å–æ–∫–æ–≥–æ z-index) */
  /* canvas –Ω–∏–∂—á–µ –º–∞—Ä–∫–µ—Ä—ñ–≤, –∞–ª–µ –ø–∞–Ω–µ–ª—å –≤—Å–µ –æ–¥–Ω–æ –≤–∏—â–µ –∑–∞–≤–¥—è–∫–∏ z-index:3000 */
.mapboxgl-canvas { z-index: 0 !important; }
.mapboxgl-control-container { z-index: 1 !important; }
/* –º–∞—Ä–∫–µ—Ä–∏ –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ –Ω–∞–¥ canvas */
.mapboxgl-marker { z-index: 2 !important; }
</style>
</head>
<body>
<!-- –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥—É -->
<header style="background:#2563eb;color:#fff;padding:10px;display:flex;gap:16px;">
  <a href="/" style="color:#fff;text-decoration:none;">üè† –ö–∞—Ä—Ç–∞</a>
  <a href="/export/" style="color:#fff;text-decoration:none;">üì§ –ï–∫—Å–ø–æ—Ä—Ç</a>
  <a href="/import/" style="color:#fff;text-decoration:none;">üì• –Ü–º–ø–æ—Ä—Ç</a>
</header>

<div id="controls">
<!-- –ú—ñ–Ω—ñ-–±–∞—Ä (–≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –ª–∏—à–µ —É –º—ñ–Ω—ñ-—Ä–µ–∂–∏–º—ñ) -->
<div class="mini-bar">
  <button id="toggleAddMini" class="btn">–ú–∞—Ä—à—Ä—É—Ç</button>
  <button id="clearRouteMini" class="btn">–û—á–∏—Å—Ç–∏—Ç–∏</button>
  <button id="saveToDBMini" class="btn">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
</div>

<!-- –ü–µ—Ä–µ–º–∏–∫–∞—á –º—ñ–Ω—ñ-—Ä–µ–∂–∏–º—É -->
<!-- <button id="toggleMini" class="btn toggleMini">‚Üî –ó–≥–æ—Ä–Ω—É—Ç–∏</button> -->

  <!-- –ö–µ—Ä—É–≤–∞–Ω–Ω—è —Ä–µ–∂–∏–º–∞–º–∏ -->
  <button id="toggleAdd" class="btn">–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–∞—Ä—à.: –í–ò–ú–ö–ù–ï–ù–û.</button>
  <button id="startLineMode" class="btn">–õ—ñ–Ω—ñ–π–∫–∞ –Ω–∞ –ø–æ—á.: –í–ò–ú–ö–ù–ï–ù–û.</button>
  <button id="endLineMode" class="btn">–õ—ñ–Ω—ñ–π–∫–∞ –≤ –∫—ñ–Ω.: –í–ò–ú–ö–ù–ï–ù–û.</button>
  <button id="clearRoute" class="btn">–û—á–∏—Å—Ç. –º–∞—Ä—à.</button>
  <button id="clearRulers" class="btn">–û—á–∏—Å—Ç. –ª—ñ–Ω.</button>
  <button id="saveRoute" class="btn">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –º–∞—Ä—à—Ä—É—Ç (JSON)</button>
  <button id="loadRoute" class="btn">üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç (JSON)</button>
  <button id="toggleMarkers" class="btn">üìç –ü–æ–∫–∞–∑–∞—Ç–∏ —Ç–æ—á–∫–∏</button>
  <input type="file" id="fileInput" accept=".json" style="display:none;" />
  <div>–ö—ñ–ª–æ–º–µ—Ç—Ä–∞–∂: <span id="distance">0</span> –∫–º</div>

  <!-- –ù–æ–≤—ñ –ø–æ–ª—è –º–∞—Ä—à—Ä—É—Ç—É -->
  <hr/>
  <div class="row">
    <div>
      <label>–í—ñ–¥</label>
      <input id="fromName" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É..." list="directoryList" autocomplete="off">
    </div>
    <div>
      <label>–î–æ</label>
      <input id="toName" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É..." list="directoryList" autocomplete="off">
    </div>
  </div>
  <datalist id="directoryList"></datalist>

  <div class="row" style="margin-top:6px;">
    <div>
      <label>–¢–∏–ø –º–∞—Ä—à—Ä—É—Ç—É</label>
      <select id="routeType">
        <option value="–û—Å–Ω–æ–≤–Ω–∏–π">–û—Å–Ω–æ–≤–Ω–∏–π</option>
        <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1</option>
        <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2</option>
      </select>
    </div>
    <div>
      <label>–ü—Ä–æ–º—ñ–∂–Ω—ñ –ø—É–Ω–∫—Ç–∏</label>
      <input id="intermediateText" type="text" placeholder="–ù–∞–ø—Ä.: –ù–µ–º–∏—Ä—ñ–≤; –ì–∞–π—Å–∏–Ω; –¢—É–ª—å—á–∏–Ω">
    </div>
  </div>
  <small class="muted">–£ –ë–î –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è <b>–∫–æ–¥–∏</b> ‚Äú–í—ñ–¥/–î–æ‚Äù. –ù–∞–∑–≤–∞ –º–∞—Ä—à—Ä—É—Ç—É –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∑ –∞–∫—Ç—É–∞–ª—å–Ω–∏—Ö –Ω–∞–∑–≤ –¥–æ–≤—ñ–¥–Ω–∏–∫–∞.</small>

  <details>
  <summary><b>–°—Ç–∏–ª—å –∫–∞—Ä—Ç–∏</b></summary>
  <div id="styleSelector" style="margin-top:10px;">
    <label for="mapStyle">–°—Ç–∏–ª—å –∫–∞—Ä—Ç–∏:</label>
    <select id="mapStyle">
      <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
      <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
      <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite Streets</option>
      <option value="mapbox://styles/mapbox/outdoors-v12">Outdoors</option>
      <option value="mapbox://styles/mapbox/light-v11">Light</option>
      <option value="mapbox://styles/mapbox/dark-v11">Dark</option>
      <option value="mapbox://styles/mapbox/navigation-day-v1">Navigation Day</option>
      <option value="mapbox://styles/mapbox/navigation-night-v1">Navigation Night</option>
      <option value="mapbox://styles/tkchk/cmdzvf97b00vq01qscpgsf1jt">map</option>
    </select>
  </div>
</details>


  <!-- –ö–µ—Ä—É–≤–∞–Ω–Ω—è –ë–î -->
  <div id="dbControls">
    <div><strong>–ë–∞–∑–∞ (Firestore)</strong></div>
    <input id="routeName" type="text" placeholder="–ù–∞–∑–≤–∞ –º–∞—Ä—à—Ä—É—Ç—É (–∑–≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, –º–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏)" />
    <button id="saveToDB" class="btn">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –≤ –ë–î</button>
    <br/>
	<input id="routeSearch" type="text"
       placeholder="üîé –ü–æ—à—É–∫ –º–∞—Ä—à—Ä—É—Ç—É..."
       list="routesList" autocomplete="off" />
	<datalist id="routesList"></datalist>
    <select id="remoteRoutes" style="min-width:260px">
      <option value="">‚Äî –≤–∏–±–µ—Ä–∏ –º–∞—Ä—à—Ä—É—Ç –∑ –ë–î ‚Äî</option>
    </select>
    <button id="refreshList" class="btn">üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
    <button id="loadFromDB" class="btn">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ –ë–î</button>
    <button id="deleteFromDB" class="btn">üóë –í–∏–¥–∞–ª–∏—Ç–∏ –∑ –ë–î</button>
	<button id="clearForm" class="btn">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É</button>
  </div>
</div>
<button id="panelToggle" class="btn panel-toggle" title="–°—Ö–æ–≤–∞—Ç–∏ –ø–∞–Ω–µ–ª—å">‚óÄ –°—Ö–æ–≤–∞—Ç–∏</button>
<div id="map"></div>

<div id="contextMenu">
  <div id="insertAfter">‚ûï–í—Å—Ç–∞–≤–∏—Ç–∏ –ø—ñ—Å–ª—è</div>
  <div id="deletePoint">‚ùå–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ—á–∫—É</div>
</div>

<script>
/* ===================== Mapbox init ===================== */
mapboxgl.accessToken = 'pk.eyJ1IjoidGtjaGsiLCJhIjoiY21keTN0bXVlMjN6djJrczZ2NDk5bXRoMiJ9.6n1kuiUJ3EdGUpz5I6-wdg';
let currentStyle = 'mapbox://styles/mapbox/streets-v12';
const map = new mapboxgl.Map({ container: 'map', style: currentStyle, center: [30.5238, 50.4547], zoom: 10 });

let addMode = false, startLineMode = false, endLineMode = false;
let insertAfterMode = false;
let points = [], markers = [], startRuler = [], endRuler = [], rulerLines = [], routeLayers = [];
let selectedMarkerIndex = null;

const contextMenu = document.getElementById('contextMenu');
const insertAfterBtn = document.getElementById('insertAfter');
const deletePointBtn = document.getElementById('deletePoint');

map.on('style.load', () => { updateRoute(); drawRulers(); });

document.getElementById('mapStyle').addEventListener('change', function() {
  currentStyle = this.value;
  map.setStyle(currentStyle);
});

/* –ü–Ü–î–°–í–Ü–ß–£–í–ê–ù–ù–Ø —Å—Ç–∞–Ω—É –∫–Ω–æ–ø–æ–∫ */
function toggleButton(id, flag) {
  const btn = document.getElementById(id);
  btn.textContent = btn.textContent.split(':')[0] + `: ${flag ? '–£–í–Ü–ú–ö–ù–ï–ù–û.' : '–í–ò–ú–ö–ù–ï–ù–û.'}`;
  if (flag) btn.classList.add('active'); else btn.classList.remove('active');
}

document.getElementById('toggleAdd').onclick = () => {
  addMode = !addMode; startLineMode = false; endLineMode = false; insertAfterMode = false;
  toggleButton('toggleAdd', addMode); toggleButton('startLineMode', false); toggleButton('endLineMode', false);
};
document.getElementById('startLineMode').onclick = () => {
  startLineMode = !startLineMode; endLineMode = false; addMode = false; insertAfterMode = false;
  toggleButton('startLineMode', startLineMode); toggleButton('endLineMode', false); toggleButton('toggleAdd', false);
};
document.getElementById('endLineMode').onclick = () => {
  endLineMode = !endLineMode; startLineMode = false; addMode = false; insertAfterMode = false;
  toggleButton('endLineMode', endLineMode); toggleButton('startLineMode', false); toggleButton('toggleAdd', false);
};
document.getElementById('clearRulers').onclick = () => { startRuler = []; endRuler = []; drawRulers(); updateRoute(); };
document.getElementById('clearRoute').onclick = () => {
  points = []; markers.forEach(m => m.remove()); markers = [];
  clearRouteLayers(); updateRoute();
};

map.on('click', (e) => {
  const lngLat = [e.lngLat.lng, e.lngLat.lat];
  contextMenu.style.display = 'none';

  if (insertAfterMode && selectedMarkerIndex !== null) {
    points.splice(selectedMarkerIndex + 1, 0, lngLat);
    insertAfterMode = false; rebuildMarkers(); return;
  }
  if (startLineMode) { startRuler.push(lngLat); drawRulers(); updateRoute(); return; }
  if (endLineMode) { endRuler.push(lngLat); drawRulers(); updateRoute(); return; }
  if (addMode) { points.push(lngLat); addMarker(lngLat); updateRoute(); }
});

function addMarker(lngLat, index = points.length - 1) {
  const marker = new mapboxgl.Marker({ draggable: false }).setLngLat(lngLat).addTo(map);
  marker.getElement().addEventListener('contextmenu', (e) => {
    e.preventDefault();
    selectedMarkerIndex = index;
    contextMenu.style.left = e.pageX + 'px';
    contextMenu.style.top = e.pageY + 'px';
    contextMenu.style.display = 'block';
  });
  markers.push(marker);
}

insertAfterBtn.onclick = () => { if (selectedMarkerIndex !== null) insertAfterMode = true; contextMenu.style.display = 'none'; };
deletePointBtn.onclick = () => {
  if (selectedMarkerIndex !== null) { points.splice(selectedMarkerIndex, 1); rebuildMarkers(); }
  contextMenu.style.display = 'none';
};
document.addEventListener('click', () => { contextMenu.style.display = 'none'; });

function rebuildMarkers() {
  markers.forEach(m => m.remove()); markers = [];
  points.forEach((pt, idx) => addMarker(pt, idx));
  updateRoute();
}

let markersVisible = true;
document.getElementById('toggleMarkers').onclick = () => {
  markersVisible = !markersVisible;
  markers.forEach(m => m.getElement().style.display = markersVisible ? 'block' : 'none');
  document.getElementById('toggleMarkers').textContent =
    markersVisible ? 'üìç –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —Ç–æ—á–∫–∏' : 'üìç –ü–æ–∫–∞–∑–∞—Ç–∏ —Ç–æ—á–∫–∏';
};

function drawRulers() {
  rulerLines.forEach(id => { if (map.getLayer(id)) map.removeLayer(id); if (map.getSource(id)) map.removeSource(id); });
  rulerLines = [];
  drawRulerSegment(startRuler, 'start', '#0066ff');
  drawRulerSegment(endRuler, 'end', '#33cc33');
}
function drawRulerSegment(ruler, prefix, color) {
  for (let i = 0; i < ruler.length - 1; i++) {
    const lineId = `${prefix}-ruler-${i}`;
    const geojson = { type: 'Feature', geometry: { type: 'LineString', coordinates: [ruler[i], ruler[i + 1]] } };
    map.addSource(lineId, { type: 'geojson', data: geojson });
    map.addLayer({ id: lineId, type: 'line', source: lineId,
      layout: { 'line-join': 'round', 'line-cap': 'round' },
      paint: { 'line-color': color, 'line-width': 4, 'line-dasharray': [1, 2] } });
    rulerLines.push(lineId);
  }
}

function calculateRulerDistance(ruler) {
  let dist = 0;
  for (let i = 0; i < ruler.length - 1; i++) {
    dist += turf.distance(turf.point(ruler[i]), turf.point(ruler[i + 1]));
  }
  return dist;
}

function splitIntoChunks(array, chunkSize) {
  const chunks = [];
  for (let i = 0; i < array.length - 1; i += chunkSize - 1) {
    const chunk = array.slice(i, i + chunkSize);
    if (chunk.length >= 2) chunks.push(chunk);
  }
  return chunks;
}

function clearRouteLayers() {
  routeLayers.forEach(id => {
    if (map.getLayer(id)) map.removeLayer(id);
    if (map.getSource(id)) map.removeSource(id);
  });
  routeLayers = [];
}

async function updateRoute() {
  if (points.length < 2) {
    document.getElementById('distance').textContent =
      (calculateRulerDistance(startRuler) + calculateRulerDistance(endRuler)).toFixed(2);
    clearRouteLayers(); return;
  }

  const chunks = splitIntoChunks(points, 20);
  let totalDistance = 0;
  clearRouteLayers();

  for (let i = 0; i < chunks.length; i++) {
    const chunk = chunks[i];
    const coordsStr = chunk.map(p => p.join(',')).join(';');
    const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coordsStr}?geometries=geojson&access_token=${mapboxgl.accessToken}`;

    try {
      const res = await fetch(url);
      const data = await res.json();
      if (data.routes && data.routes[0]) {
        const route = data.routes[0];
        totalDistance += route.distance;
        const layerId = `route-part-${i}`;

        map.addSource(layerId, { type: 'geojson', data: { type: 'Feature', geometry: route.geometry } });
        map.addLayer({
          id: layerId, type: 'line', source: layerId,
          layout: { 'line-join': 'round', 'line-cap': 'round' },
          paint: { 'line-color': `hsl(${(i * 60) % 360}, 100%, 50%)`, 'line-width': 5 }
        });
        routeLayers.push(layerId);
      }
    } catch (e) { console.error('–ü–æ–º–∏–ª–∫–∞ –º–∞—Ä—à—Ä—É—Ç—É:', e); }
  }

  totalDistance = (totalDistance / 1000) + calculateRulerDistance(startRuler) + calculateRulerDistance(endRuler);
  document.getElementById('distance').textContent = totalDistance.toFixed(2);
}

/* turf */
const turfScript = document.createElement('script');
turfScript.src = 'https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js';
document.head.appendChild(turfScript);

/* =============== –õ–æ–∫–∞–ª—å–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ JSON =============== */
document.getElementById('saveRoute').onclick = () => {
  const routeData = {
    name: (document.getElementById('routeName').value || '–ë–µ–∑ –Ω–∞–∑–≤–∏'),
    points, startRuler, endRuler,
    date: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(routeData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'route_' + new Date().toISOString().replace(/[:.]/g, '-') + '.json';
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
};

const fileInput = document.getElementById('fileInput');
document.getElementById('loadRoute').onclick = () => { fileInput.value = null; fileInput.click(); };
fileInput.onchange = (event) => {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const routeData = JSON.parse(e.target.result);
      if (!routeData.points || !Array.isArray(routeData.points)) { alert('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª—É'); return; }
      points = routeData.points || []; startRuler = routeData.startRuler || []; endRuler = routeData.endRuler || [];
      document.getElementById('routeName').value = routeData.name || '';
      rebuildMarkers(); drawRulers(); updateRoute();
      if (points.length > 0) map.flyTo({ center: points[0], zoom: 12 });
      alert('–ú–∞—Ä—à—Ä—É—Ç —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ —Ñ–∞–π–ª—É!');
    } catch (err) { alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ: ' + err.message); }
  };
  reader.readAsText(file);
};

/* ===================== Firestore ===================== */
/* 1) –¢–≤–æ—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyDjDBZkmy-skuDEQF8-AkRma7yw6TugoQc",
  authDomain: "my-map-app-58312.firebaseapp.com",
  projectId: "my-map-app-58312",
  storageBucket: "my-map-app-58312.firebasestorage.app",
  messagingSenderId: "53260611353",
  appId: "1:53260611353:web:f25e120996ad8305405f88",
  measurementId: "G-9LRX1FLTKL"
};

let db = null;
try {
  const fbApp = firebase.apps && firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  console.log('‚úÖ Firebase —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ:', firebaseConfig.projectId);
} catch (e) {
  console.error('‚ùå Firebase –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ:', e);
}

/* ===== –î–æ–≤—ñ–¥–Ω–∏–∫: code <-> details(name, company, unit) ===== */
const dirByCode = {};   // { code: {name, company, unit} }
const codeByName = {};  // { name: code }  (–¥–ª—è –ø—ñ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞ –Ω–∞–∑–≤–æ—é)
const routesLookup = {}; // label -> doc.id –¥–ª—è –ø–æ—à—É–∫—É

async function loadDirectory() {
  if (!db) return;
  const snap = await db.collection('directory').get();
  const list = document.getElementById('directoryList');
  list.innerHTML = '';
  Object.keys(dirByCode).forEach(k => delete dirByCode[k]);
  Object.keys(codeByName).forEach(k => delete codeByName[k]);

  snap.forEach(doc => {
    const code = doc.id;
    const d = doc.data() || {};
    const name = d.name || code;
    const company = d.company || '';
    const unit = d.unit || '';
    dirByCode[code] = { name, company, unit };
    if (!(name in codeByName)) codeByName[name] = code;

    const opt = document.createElement('option');
    opt.value = name; // datalist —à—É–∫–∞—î –ø–æ value
    opt.label = [name, unit, company].filter(Boolean).join(' ‚Ä¢ '); // –ø—ñ–¥–∫–∞–∑–∫–∞
    list.appendChild(opt);
  });
  
  // üîπ –æ—Å—å —Ç—É—Ç –æ–Ω–æ–≤–ª—é—î–º–æ –Ω–∞–∑–≤—É –º–∞—Ä—à—Ä—É—Ç—É —Ç–∞ —Å–ø–∏—Å–æ–∫ –ø—ñ—Å–ª—è –∑–º—ñ–Ω–∏ –¥–æ–≤—ñ–¥–Ω–∏–∫–∞
  updateRouteName();
  refreshRoutesList();

  console.log('üìí –î–æ–≤—ñ–¥–Ω–∏–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:', Object.keys(dirByCode).length, '–∑–∞–ø–∏—Å(—ñ–≤)');
}

/* helpers */
function toObjPoints(arr) { return (arr || []).map(p => ({ lng: p[0], lat: p[1] })); }
function fromObjPoints(arr) { return (arr || []).map(p => [p.lng, p.lat]); }
function getCodeByInput(inputId) {
  const name = document.getElementById(inputId).value.trim();
  return codeByName[name] || null;
}
function getNameByCode(code) {
  return (dirByCode[code]?.name) || '';
}
function formatRouteTitle(data) {
  const from = dirByCode[data.fromCode]?.name || '–Ω–µ–≤—ñ–¥–æ–º–æ';
  const to   = dirByCode[data.toCode]?.name   || '–Ω–µ–≤—ñ–¥–æ–º–æ';
  const type = data.routeType || '–û—Å–Ω–æ–≤–Ω–∏–π';
  return `${from} ‚Üí ${to} [${type}]`;
}
function updateRouteName() {
  const fromCode = getCodeByInput('fromName');
  const toCode = getCodeByInput('toName');
  const routeType = document.getElementById('routeType').value;

  if (!fromCode || !toCode) return;

  const from = dirByCode[fromCode] || {};
  const to   = dirByCode[toCode] || {};
  const fromLabel = [from.name, from.unit, from.company].filter(Boolean).join(' ‚Ä¢ ');
  const toLabel   = [to.name, to.unit, to.company].filter(Boolean).join(' ‚Ä¢ ');

  document.getElementById('routeName').value = `${fromLabel} ‚Üí ${toLabel} [${routeType}]`;
}

/* 2) –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è Firestore */
async function saveToDB() {
  try {
    if (!db) { alert('–ë–î –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞'); return; }
    if (points.length === 0 && startRuler.length === 0 && endRuler.length === 0) {
      alert('–ù–µ–º–∞—î —â–æ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏'); return;
    }

    const fromCode = getCodeByInput('fromName');
    const toCode   = getCodeByInput('toName');
    const routeType = document.getElementById('routeType').value;
    const intermediateText = document.getElementById('intermediateText').value.trim();

    if (!fromCode || !toCode) {
      alert('–û–±–µ—Ä—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è ‚Äú–í—ñ–¥‚Äù —Ç–∞ ‚Äú–î–æ‚Äù –∑—ñ —Å–ø–∏—Å–∫—É –¥–æ–≤—ñ–¥–Ω–∏–∫–∞.');
      return;
    }

    // –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –Ω–∞–∑–≤—É –∑ –∞–∫—Ç—É–∞–ª—å–Ω–∏–º–∏ –¥–µ—Ç–∞–ª—è–º–∏
    const from = dirByCode[fromCode] || {};
    const to   = dirByCode[toCode] || {};
    const fromLabel = [from.name, from.unit, from.company].filter(Boolean).join(' ‚Ä¢ ');
    const toLabel   = [to.name, to.unit, to.company].filter(Boolean).join(' ‚Ä¢ ');
    const generatedName = `${fromLabel} ‚Üí ${toLabel} [${routeType}]`;

    const manual = (document.getElementById('routeName').value || '').trim();
    const finalName = manual || generatedName;

    const payload = {
      name: finalName,
      fromCode, toCode, routeType, intermediateText,
      points: toObjPoints(points),
      startRuler: toObjPoints(startRuler),
      endRuler: toObjPoints(endRuler),
      distance_km: parseFloat(document.getElementById('distance').textContent) || 0,
      updatedAt: new Date().toISOString()
    };

    console.log('‚û°Ô∏è –ó–±–µ—Ä—ñ–≥–∞—é –º–∞—Ä—à—Ä—É—Ç:', payload);
    // –ì–µ–Ω–µ—Ä—É—î–º–æ –±–µ–∑–ø–µ—á–Ω–∏–π ID –±–µ–∑ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∏—Ö —Å–∏–º–≤–æ–ª—ñ–≤
const safeId = finalName.replace(/[\/\\#?[\]]/g, '_');

// –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ –ë–î –∑ –±–µ–∑–ø–µ—á–Ω–∏–º ID, –∞–ª–µ –∑ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ—é –Ω–∞–∑–≤–æ—é —É –ø–æ–ª—ñ "name"
await db.collection('routes').doc(safeId).set(payload, { merge: true });


    alert('‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ –≤ –ë–î: ' + finalName);
    await refreshRoutesList();
  } catch (err) {
    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ Firestore:', err);
    alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –≤ –ë–î: ' + (err?.message || err));
  }
}
let isRefreshingRoutes = false; // –î–û–î–ê–ô –≤–∏—â–µ –∑–∞ —Ñ—É–Ω–∫—Ü—ñ—é, –æ–¥–∏–Ω —Ä–∞–∑

async function refreshRoutesList() {
  if (!db || isRefreshingRoutes) return;
  isRefreshingRoutes = true;
  try {
    const sel  = document.getElementById('remoteRoutes');
    const list = document.getElementById('routesList');
    const current = sel.value;

    // –æ—á–∏—Å—Ç–∏—Ç–∏ —Å–µ–ª–µ–∫—Ç, datalist —ñ —ñ–Ω–¥–µ–∫—Å
    sel.innerHTML = '<option value="">‚Äî –≤–∏–±–µ—Ä–∏ –º–∞—Ä—à—Ä—É—Ç –∑ –ë–î ‚Äî</option>';
    list.innerHTML = '';
    for (const k in routesLookup) delete routesLookup[k];

    const snap = await db.collection('routes')
      .orderBy('updatedAt', 'desc')
      .limit(200)
      .get();

    snap.forEach(doc => {
      const d = doc.data();
      const km = (typeof d.distance_km === 'number') ? ` (${d.distance_km.toFixed(2)} –∫–º)` : '';
      const labelNow = formatRouteTitle(d);
      const label = labelNow + km;

      // —Å–µ–ª–µ–∫—Ç
      const opt = document.createElement('option');
      opt.value = doc.id;
      opt.textContent = label;
      sel.appendChild(opt);

      // —ñ–Ω–¥–µ–∫—Å + datalist
      routesLookup[label] = doc.id;
      const sOpt = document.createElement('option');
      sOpt.value = label;
      list.appendChild(sOpt);
    });

    if (Array.from(sel.options).some(o => o.value === current)) {
      sel.value = current;
    }
  } finally {
    isRefreshingRoutes = false;
  }
}

async function loadFromDB() {
  try {
    if (!db) { alert('–ë–î –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞'); return; }
    const sel = document.getElementById('remoteRoutes');
    const id = sel.value;
    if (!id) { alert('–û–±–µ—Ä—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç —É —Å–ø–∏—Å–∫—É'); return; }

    const docRef = db.collection('routes').doc(id);
    const docSnap = await docRef.get();
    if (!docSnap.exists) { alert('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ'); return; }
    const data = docSnap.data();
updateRouteName();

    // –ü–æ–ª—è —Ñ–æ—Ä–º–∏
    document.getElementById('fromName').value = getNameByCode(data.fromCode) || '';
    document.getElementById('toName').value   = getNameByCode(data.toCode) || '';
    document.getElementById('routeType').value = data.routeType || '–û—Å–Ω–æ–≤–Ω–∏–π';
    document.getElementById('intermediateText').value = data.intermediateText || '';
    document.getElementById('routeName').value = formatRouteTitle(data);

    // –¢–æ—á–∫–∏
    points = fromObjPoints(data.points || []);
    startRuler = fromObjPoints(data.startRuler || []);
    endRuler = fromObjPoints(data.endRuler || []);

    rebuildMarkers();
    drawRulers();
    updateRoute();
    if (points.length > 0) map.flyTo({ center: points[0], zoom: 12 });
    alert('–ú–∞—Ä—à—Ä—É—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ –ë–î: ' + id);
  } catch (err) {
    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ –ë–î:', err);
    alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏: ' + (err?.message || err));
  }
}

async function deleteFromDB() {
  try {
    if (!db) { alert('–ë–î –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞'); return; }
    const sel = document.getElementById('remoteRoutes');
    const id = sel.value;
    if (!id) { alert('–û–±–µ—Ä—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç —É —Å–ø–∏—Å–∫—É'); return; }
    if (!confirm(`–¢–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç "${id}"?`)) return;

    await db.collection('routes').doc(id).delete();
    alert('–í–∏–¥–∞–ª–µ–Ω–æ –∑ –ë–î: ' + id);
    await refreshRoutesList();
  } catch (err) {
    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑ –ë–î:', err);
    alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏: ' + (err?.message || err));
  }
}

/* –ü—Ä–∏–≤‚Äô—è–∑–∫–∞ –∫–Ω–æ–ø–æ–∫ + –∞–≤—Ç–æ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–æ–≤—ñ–¥–Ω–∏–∫–∞/—Å–ø–∏—Å–∫—É */
document.getElementById('saveToDB').onclick = saveToDB;
let lastRefreshClick = 0;
document.getElementById('refreshList').onclick = () => {
  const now = Date.now();
  if (now - lastRefreshClick < 500) return; // —ñ–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–¥–≤—ñ–π–Ω–∏–π –∫–ª—ñ–∫ < 0.5—Å
  lastRefreshClick = now;
  refreshRoutesList();
};

document.getElementById('loadFromDB').onclick = loadFromDB;
document.getElementById('deleteFromDB').onclick = deleteFromDB;
document.getElementById('clearForm').onclick = clearForm;
// –ü–æ—à—É–∫ –º–∞—Ä—à—Ä—É—Ç—É –∑–∞ –≤–≤–µ–¥–µ–Ω–∏–º —Ç–µ–∫—Å—Ç–æ–º —É –ø–æ–ª—ñ routeSearch
const routeSearch = document.getElementById('routeSearch');
const remoteRoutesSel = document.getElementById('remoteRoutes');

// –∫–æ–ª–∏ –¥—Ä—É–∫—É—î–º–æ ‚Äî –ø—ñ–¥—Å–≤—ñ—á—É—î–º–æ –ø–µ—Ä—à–∏–π –∑–±—ñ–≥ —É —Å–ø–∏—Å–∫—É
routeSearch.addEventListener('input', () => {
  const q = routeSearch.value.trim().toLowerCase();
  let matched = false;

  for (const opt of remoteRoutesSel.options) {
    const text = (opt.textContent || '').toLowerCase();
    if (text.includes(q) && opt.value) {   // –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ placeholder
      remoteRoutesSel.value = opt.value;
      matched = true;
      break;
    }
  }
  if (!matched) remoteRoutesSel.value = ''; // –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π—à–ª–∏
});

// –Ω–∞—Ç–∏—Å–Ω—É–ª–∏ Enter —É –ø–æ–ª—ñ ‚Äî –æ–¥—Ä–∞–∑—É –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤–∏–±—Ä–∞–Ω–µ
routeSearch.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    if (!remoteRoutesSel.value) {
      // —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑ –∑–Ω–∞–π—Ç–∏ –ø–µ—Ä—à–∏–π –∑–±—ñ–≥
      const ev = new Event('input');
      routeSearch.dispatchEvent(ev);
    }
    if (remoteRoutesSel.value) {
      document.getElementById('loadFromDB').click();
    }
  }
});

function clearForm() {
  // –û—á–∏—Å—Ç–∏—Ç–∏ —Ç–µ–∫—Å—Ç–æ–≤—ñ –ø–æ–ª—è
  document.getElementById('fromName').value = '';
  document.getElementById('toName').value = '';
  document.getElementById('routeType').value = '–û—Å–Ω–æ–≤–Ω–∏–π';
  document.getElementById('intermediateText').value = '';
  document.getElementById('routeName').value = '';
  document.getElementById('distance').textContent = '0';

  // –û—á–∏—Å—Ç–∏—Ç–∏ —Ç–æ—á–∫–∏ —Ç–∞ –ª—ñ–Ω—ñ–π–∫–∏
  points = [];
  startRuler = [];
  endRuler = [];
  rebuildMarkers();
  drawRulers();
  updateRoute();

  // –°–∫–∏–Ω—É—Ç–∏ –≤–∏–±—Ä–∞–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç —É —Å–ø–∏—Å–∫—É
  document.getElementById('remoteRoutes').value = '';

  alert('–§–æ—Ä–º–∞ –æ—á–∏—â–µ–Ω–∞');
}

window.addEventListener('load', () => { if (db) { loadDirectory(); } });
document.getElementById('fromName').addEventListener('change', updateRouteName);
document.getElementById('toName').addEventListener('change', updateRouteName);
document.getElementById('routeType').addEventListener('change', updateRouteName);

/* // –ü–µ—Ä–µ–º–∏–∫–∞—á –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ (–º—ñ–Ω—ñ) —Ä–µ–∂–∏–º—É
const controlsEl = document.getElementById('controls');
const toggleMiniBtn = document.getElementById('toggleMini');
if (toggleMiniBtn) {
  toggleMiniBtn.addEventListener('click', () => {
    controlsEl.classList.toggle('mini');
  });
}

// –ú—ñ–Ω—ñ-–±–∞—Ä: –¥—É–±–ª—é—î –¥—ñ—ó –≤–µ–ª–∏–∫–∏—Ö –∫–Ω–æ–ø–æ–∫
document.getElementById('toggleAddMini')?.addEventListener('click', () =>
  document.getElementById('toggleAdd').click()
);
document.getElementById('clearRouteMini')?.addEventListener('click', () =>
  document.getElementById('clearRoute').click()
);
document.getElementById('saveToDBMini')?.addEventListener('click', () =>
  document.getElementById('saveToDB').click()
); */
// –ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ –ø–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è
const panelToggle = document.getElementById('panelToggle');
const controlsBox = document.getElementById('controls');

function positionPanelToggle(){
  const hidden = document.body.classList.contains('controls-hidden');
  if (hidden){
    panelToggle.style.left = '12px';
  } else {
    const w = controlsBox.offsetWidth;
    panelToggle.style.left = (w + 16) + 'px';
  }
}

function updatePanelToggleLabel(){
  const hidden = document.body.classList.contains('controls-hidden');
  panelToggle.textContent = hidden ? '‚ñ∂ –ü–∞–Ω–µ–ª—å' : '‚óÄ –°—Ö–æ–≤–∞—Ç–∏';
  if (typeof map?.resize === 'function') requestAnimationFrame(() => map.resize());
  positionPanelToggle();
}

panelToggle.addEventListener('click', () => {
  document.body.classList.toggle('controls-hidden');
  updatePanelToggleLabel();
});

updatePanelToggleLabel();
window.addEventListener('resize', positionPanelToggle);

</script>
</body>
</html>
