<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>‚úÖ –ü–æ–≥–æ–¥–∂–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <style>
    :root { --line:#e5e7eb; --card:#fff; --muted:#6b7280; --nav-real:56px; }

    html, body { height:100%; }
    *{ box-sizing:border-box }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:#f8fafc;
    }

    header{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; gap:8px;
      padding:10px 12px; background:#0ea5e9; color:#fff
    }
    header a{ color:#fff; text-decoration:none }

    /* === Fullscreen review layout === */
    #reviewWrap{
      position:absolute; inset:var(--nav-real) 0 0 0;  /* –∑–∞–π–º–∞—î –≤–µ—Å—å –µ–∫—Ä–∞–Ω –ø—ñ–¥ —Ö–µ–¥–µ—Ä–æ–º */
      padding:8px;
    }
    .review-card{
      height:100%; width:100%;
      display:grid; grid-template-rows:auto 1fr auto;
      background:var(--card); border:1px solid var(--line);
      border-radius:12px; box-shadow:0 1px 10px rgba(0,0,0,.08);
    }

    .pad{ padding:12px }
    .title{ font-weight:800; font-size:20px; margin:0 0 6px }
    .muted{ color:var(--muted); font-size:13px }
    .chip{
      display:inline-block; border:1px solid var(--line); border-radius:999px;
      padding:4px 10px; background:#f3f4f6; font-size:12.5px
    }
    .btn{
      cursor:pointer; border:1px solid var(--line); background:#fff; border-radius:10px;
      padding:9px 12px; font-size:14px
    }
    .btn.good{ background:#e6f4ea; border-color:#22c55e }
    .btn.bad{ background:#fee2e2; border-color:#ef4444 }
    .btnRow{ display:flex; gap:8px; flex-wrap:wrap }

    label{ display:block; font-size:13px; margin:6px 0 4px }
    textarea{
      width:100%; min-height:90px; border:1px solid var(--line); border-radius:10px;
      padding:8px; resize:vertical
    }

    /* –∫–∞—Ä—Ç–∞ ‚Äî –∑–∞–π–º–∞—î –≤—Å—é —Å–µ—Ä–µ–¥–Ω—é ‚Äú—Ä—è–¥–∫—É‚Äù –∫–∞—Ä—Ç–∫–∏ */
    #map{ width:100%; height:100%; border-top:1px dashed var(--line); border-bottom:1px dashed var(--line); }

    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    @media(max-width:900px){ .row{ grid-template-columns:1fr } }
  </style>
</head>
<body>
<header>
  <a href="/index.html">üè† –ú–∞—Ä—à—Ä—É—Ç–∏</a>
  <div style="flex:1"></div>
  <span id="hello" class="muted">–ù–µ —É–≤—ñ–π—à–ª–∏</span>
</header>

<!-- fullscreen –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
<div id="reviewWrap">
  <div class="review-card">
    <div class="pad">
      <div class="title">–ü–æ–≥–æ–¥–∂–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É</div>
      <div id="statusLine" class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>

      <div class="btnRow" id="secButtons" style="margin-top:8px; display:none;">
        <button id="approveBtn" class="btn good">‚úÖ –ü–æ–≥–æ–¥–∏—Ç–∏</button>
        <button id="rejectBtn"  class="btn bad">‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
        <a id="openEditor" class="btn" target="_blank">üó∫ –í—ñ–¥–∫—Ä–∏—Ç–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä—ñ</a>
      </div>

      <div id="rejectWrap" style="display:none; margin-top:10px;">
        <label>–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è (–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)</label>
        <textarea id="rejectComment" placeholder="–û–ø–∏—à—ñ—Ç—å, —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏"></textarea>
        <div class="btnRow" style="margin-top:6px;">
          <button id="sendReject" class="btn bad">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏ –∑ –∫–æ–º–µ–Ω—Ç–∞—Ä–µ–º</button>
          <button id="cancelReject" class="btn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
      </div>
    </div>

    <div id="map"></div>

    <div class="pad">
      <div class="row">
        <div>
          <div class="chip" id="chipStatus">–°—Ç–∞—Ç—É—Å: ‚Äî</div>
          <div class="chip" id="chipDistance">–î–æ–≤–∂–∏–Ω–∞: ‚Äî</div>
          <div class="chip" id="chipRevision">–ü–æ–¥–∞—á–∞ ‚Ññ ‚Äî</div>
        </div>
        <div style="text-align:right">
          <div class="muted">–ú–∞—Ä—à—Ä—É—Ç: <b id="routeName">‚Äî</b></div>
          <div class="muted">–í—ñ–¥: <b id="fromLabel">‚Äî</b> ‚Üí –î–æ: <b id="toLabel">‚Äî</b></div>
        </div>
      </div>
      <div id="decisionInfo" class="muted" style="margin-top:8px;"></div>
      <div id="rejectInfo" class="muted" style="margin-top:6px;color:#b91c1c;"></div>
    </div>
  </div>
</div>

<script>
  // === Firebase init ===
  const firebaseConfig = {
    apiKey: "AIzaSyDjDBZkmy-skuDEQF8-AkRma7yw6TugoQc",
    authDomain: "my-map-app-58312.firebaseapp.com",
    projectId: "my-map-app-58312",
    storageBucket: "my-map-app-58312.firebasestorage.app",
    messagingSenderId: "53260611353",
    appId: "1:53260611353:web:f25e120996ad8305405f88",
    measurementId: "G-9LRX1FLTKL"
  };
  try{ firebase.apps?.length ? firebase.app() : firebase.initializeApp(firebaseConfig); }catch(e){}
  const db   = firebase.firestore();
  const auth = firebase.auth();

  const qs  = new URLSearchParams(location.search);
  const rid = qs.get('rid');

  // === Mapbox init ===
  mapboxgl.accessToken = 'pk.eyJ1IjoidGtjaGsiLCJhIjoiY21keTN0bXVlMjN6djJrczZ2NDk5bXRoMiJ9.6n1kuiUJ3EdGUpz5I6-wdg';
  const map = new mapboxgl.Map({
    container:'map',
    style:'mapbox://styles/mapbox/streets-v12',
    center:[28.468,49.234],
    zoom:11
  });

  /* ---------- layout helper: –∫–∞—Ä—Ç–∞ –Ω–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω –ø—ñ–¥ —Ö–µ–¥–µ—Ä–æ–º ---------- */
  const topbarEl = document.querySelector('header');
  function updateLayoutHeights(){
    const h = (topbarEl?.offsetHeight || 56);
    document.documentElement.style.setProperty('--nav-real', h + 'px');
    try{ map.resize(); }catch{}
  }
  window.addEventListener('resize', updateLayoutHeights);
  // –∫–æ–ª–∏ –∫–∞—Ä—Ç–∞ –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏–ª–∞ —Å—Ç–∏–ª—å ‚Äî —Ç–µ–∂ –ø—ñ–¥–∂–∞—Ç–∏
  map.on('load', updateLayoutHeights);

  /* ---------- helpers ---------- */
  function fromObjPoints(arr){ return (arr||[]).map(p => Array.isArray(p) ? p : [p.lng, p.lat]); }
  function chip(id,t){ document.getElementById(id).textContent = t; }
  function fmtStatus(s){ return ({draft:'–ß–µ—Ä–Ω–µ—Ç–∫–∞',pending:'–û—á—ñ–∫—É—î',approved:'–ü–æ–≥–æ–¥–∂–µ–Ω–æ',rejected:'–í—ñ–¥—Ö–∏–ª–µ–Ω–æ'})[s] || s || '‚Äî'; }
  async function userRole(uid){
    try{
      const d = await db.collection('roles').doc(uid).get();
      return d.exists ? (d.data().role || 'user') : 'user';
    }catch{ return 'user'; }
  }

  // —Å–ø–ª—ñ—Ç –Ω–∞ —à–º–∞—Ç–∫–∏ (Mapbox Directions ‚â§25 –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç/–∑–∞–ø–∏—Ç; –±–µ—Ä–µ–º–æ 20 –∑ –ø–µ—Ä–µ–∫—Ä–∏—Ç—Ç—è–º)
  function splitIntoChunks(arr, chunkSize){
    const out=[]; for(let i=0;i<arr.length-1;i+=chunkSize-1){
      const chunk=arr.slice(i,i+chunkSize); if(chunk.length>=2) out.push(chunk);
    } return out;
  }

  let routeLayers = [];
  function clearRouteLayers(){
    routeLayers.forEach(id=>{
      try{ if(map.getLayer(id)) map.removeLayer(id); }catch{}
      try{ if(map.getSource(id)) map.removeSource(id); }catch{}
    });
    routeLayers = [];
  }

  // snapped-to-road —Ä–µ–Ω–¥–µ—Ä—ñ–Ω–≥ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É
  async function drawSnappedRoute(points){
    clearRouteLayers();
    if(!Array.isArray(points) || points.length<2) return;

    const chunks = splitIntoChunks(points, 20);
    let totalMeters = 0;

    // bounds
    let bMinLng=+Infinity, bMinLat=+Infinity, bMaxLng=-Infinity, bMaxLat=-Infinity;
    const grow = ([lng,lat])=>{
      if(lng<bMinLng) bMinLng=lng; if(lat<bMinLat) bMinLat=lat;
      if(lng>bMaxLng) bMaxLng=lng; if(lat>bMaxLat) bMaxLat=lat;
    };

    for(let i=0;i<chunks.length;i++){
      const coordsStr = chunks[i].map(p=>p.join(',')).join(';');
      const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coordsStr}?geometries=geojson&access_token=${mapboxgl.accessToken}`;
      try{
        const res = await fetch(url);
        const data = await res.json();
        const route = data?.routes?.[0];
        if(!route) continue;

        totalMeters += (route.distance||0);
        const geom = route.geometry;

        const srcId = `rev-route-${i}`;
        map.addSource(srcId, { type:'geojson', data:{ type:'Feature', geometry:geom }});
        map.addLayer({
          id: srcId, type:'line', source:srcId,
          layout:{ 'line-cap':'round','line-join':'round' },
          paint:{ 'line-color': `hsl(${(i*60)%360},100%,50%)`, 'line-width': 5 }
        });
        routeLayers.push(srcId);

        (geom.coordinates||[]).forEach(grow);
      }catch(e){ console.warn('Directions error', e); }
    }

    if(isFinite(bMinLng)){
      map.fitBounds([[bMinLng,bMinLat],[bMaxLng,bMaxLat]], { padding: 40, maxZoom: 14 });
    }

    // —è–∫—â–æ —î –µ–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø–æ–∫–∞–∑—É –¥–æ–≤–∂–∏–Ω–∏ ‚Äî –æ–Ω–æ–≤–∏–º–æ, –∞–ª–µ –ª–∏—à–µ —è–∫—â–æ –≤ –ë–î –Ω–µ –±—É–ª–æ –∑–Ω–∞—á–µ–Ω–Ω—è
    const distEl = document.getElementById('chipDistance');
    const km = (totalMeters/1000);
    if(distEl && (!distEl.textContent || /‚Äî$/.test(distEl.textContent.trim()))){
      chip('chipDistance', '–î–æ–≤–∂–∏–Ω–∞: ' + km.toFixed(2) + ' –∫–º');
    }
  }

  // dashed rulers
  function drawRulers(d){
    ['ruler-start','ruler-end','ruler-start-src','ruler-end-src'].forEach(id=>{
      try{ if(map.getLayer(id)) map.removeLayer(id); }catch{}
      try{ if(map.getSource(id)) map.removeSource(id); }catch{}
    });

    const rs = fromObjPoints(d.startRuler||[]);
    if (rs.length >= 2){
      map.addSource('ruler-start-src',{type:'geojson', data:{ type:'Feature', geometry:{ type:'LineString', coordinates: rs } }});
      map.addLayer({ id:'ruler-start', type:'line', source:'ruler-start-src',
        paint:{ 'line-color':'#0ea5e9','line-width':3,'line-dasharray':[1,2]}});
    }
    const re = fromObjPoints(d.endRuler||[]);
    if (re.length >= 2){
      map.addSource('ruler-end-src',{type:'geojson', data:{ type:'Feature', geometry:{ type:'LineString', coordinates: re } }});
      map.addLayer({ id:'ruler-end', type:'line', source:'ruler-end-src',
        paint:{ 'line-color':'#22c55e','line-width':3,'line-dasharray':[1,2]}});
    }
  }

  // –º–∞—Ä–∫–µ—Ä–∏ –ø–æ—á–∞—Ç–∫—É/–∫—ñ–Ω—Ü—è
  let startMarker=null, endMarker=null;
  function setSEMarkers(points){
    try{ startMarker?.remove(); endMarker?.remove(); }catch{}
    if(!points?.length) return;
    startMarker = new mapboxgl.Marker({color:'#16a34a'}).setLngLat(points[0]).addTo(map);
    endMarker   = new mapboxgl.Marker({color:'#ef4444'}).setLngLat(points[points.length-1]).addTo(map);
  }

  async function loadRouteAndRender(){
    if (!rid){ document.getElementById('statusLine').textContent = '–ù–µ –ø–µ—Ä–µ–¥–∞–Ω–æ rid.'; return; }
    const snap = await db.collection('routes').doc(rid).get();
    if (!snap.exists){ document.getElementById('statusLine').textContent = '–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.'; return; }
    const d = snap.data();

    document.getElementById('routeName').textContent = d.name || rid;
    document.getElementById('fromLabel').textContent = d.fromLabel || '‚Äî';
    document.getElementById('toLabel').textContent   = d.toLabel   || '‚Äî';
    chip('chipDistance', '–î–æ–≤–∂–∏–Ω–∞: ' + ((typeof d.distance_km==='number')? d.distance_km.toFixed(2)+' –∫–º' : '‚Äî'));
    chip('chipRevision', '–ü–æ–¥–∞—á–∞ ‚Ññ ' + ((d.approval?.revision)||'‚Äî'));
    chip('chipStatus',   '–°—Ç–∞—Ç—É—Å: ' + fmtStatus(d.approval?.status));

    const subInfo = d.approval?.submittedAt ? `–ü–æ–¥–∞–Ω–æ: ${d.approval.submittedAt} (${d.approval.submittedByEmail||d.approval.submittedByUid||''})` : '';
    const decInfo = d.approval?.decisionAt ? ` ¬∑ –†—ñ—à–µ–Ω–Ω—è: ${d.approval.decisionAt} (${d.approval.decidedByEmail||d.approval.decidedByUid||''})` : '';
    document.getElementById('decisionInfo').textContent = subInfo + decInfo;

    document.getElementById('rejectInfo').textContent = (d.approval?.status==='rejected' && d.approval?.comment)
      ? ('–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è: ' + d.approval.comment) : '';

    document.getElementById('openEditor').href = '/index.html?rid=' + encodeURIComponent(rid);
    document.getElementById('statusLine').textContent = '–ú–∞—Ä—à—Ä—É—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ.';

    // --- snapped –º–∞—Ä—à—Ä—É—Ç + dashed rulers ---
    const pts = fromObjPoints(d.points||[]);
    await drawSnappedRoute(pts);
    setSEMarkers(pts);
    drawRulers(d);
  }

  // Approve / Reject actions
  async function applyDecision(kind, comment){
    const user = auth.currentUser;
    const ref = db.collection('routes').doc(rid);
    const payload = {
      approval: {
        status: kind, // 'approved' | 'rejected'
        decisionAt: new Date().toISOString(),
        decidedByUid: user?.uid || null,
        decidedByEmail: user?.email || null,
        // –ø—Ä–∏ approve –∫–æ–º–µ–Ω—Ç–∞—Ä —á–∏—Å—Ç–∏–º–æ
        comment: kind === 'approved' ? null : (comment || '')
      },
      updatedAt: new Date().toISOString()
    };
    await ref.set(payload, { merge:true });
    await loadRouteAndRender();
    alert(kind === 'approved' ? '–ü–æ–≥–æ–¥–∂–µ–Ω–æ ‚úÖ' : '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ ‚ùå');
    document.getElementById('rejectWrap').style.display = 'none';
    document.getElementById('rejectComment').value = '';
  }

  // auth & role guard
  auth.onAuthStateChanged(async (u)=>{
    const hello = document.getElementById('hello');
    if (!u){
      hello.textContent = '–ù–µ —É–≤—ñ–π—à–ª–∏';
      location.replace('/login?next=' + encodeURIComponent(location.pathname + location.search));
      return;
    }
    hello.textContent = '–£–≤—ñ–π—à–ª–∏ —è–∫ ' + (u.email||u.uid);
    const role = await userRole(u.uid);

    // –∫–Ω–æ–ø–∫–∏ –¥–ª—è security
    const sec = (role === 'security' || role === 'admin');
    document.getElementById('secButtons').style.display = sec ? 'flex' : 'none';

    // bind buttons
    document.getElementById('approveBtn').onclick = ()=>applyDecision('approved', null);
    document.getElementById('rejectBtn').onclick  = ()=>{
      document.getElementById('rejectWrap').style.display = 'block';
      document.getElementById('rejectComment').focus();
    };
    document.getElementById('sendReject').onclick = ()=>{
      const txt = (document.getElementById('rejectComment').value||'').trim();
      if (!txt){ alert('–í–∫–∞–∂—ñ—Ç—å –ø—Ä–∏—á–∏–Ω—É –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è.'); return; }
      applyDecision('rejected', txt);
    };
    document.getElementById('cancelReject').onclick = ()=>{
      document.getElementById('rejectWrap').style.display = 'none';
    };

    // –ø—ñ–¥–∂–∞—Ç–∏ –≤–∏—Å–æ—Ç—É —ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏
    updateLayoutHeights();
    await loadRouteAndRender();
  });
</script>
</body>
</html>
