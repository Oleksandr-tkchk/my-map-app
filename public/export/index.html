<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>–ï–∫—Å–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç—ñ–≤ (Firestore ‚Üí Excel)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- SheetJS (Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- LZ-String (srcz) -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

  <style>
    :root { --w: 1080px; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f6f7f9; }
    .wrap { max-width:var(--w); margin:24px auto; padding:0 16px; }
    .card { background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.06); padding:16px; }
    h1 { margin:0 0 12px; font-size:20px; }

    .row { display:grid; gap:12px; }
    .row.cols-2 { grid-template-columns: 1fr 1fr; }
    .row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
    .row.cols-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
    .row.dates { grid-template-columns: minmax(180px,1fr) minmax(180px,1fr); gap:10px; }
    @media (max-width: 860px) { .row.cols-4 { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 640px) { .row.cols-2, .row.cols-3, .row.cols-4, .row.dates { grid-template-columns: 1fr; } }

    label { display:block; font-size:13px; color:#555; margin:4px 0; }
    input[type="text"], input[type="date"], input[type="number"], select {
      width:100%; padding:8px 10px; border:1px solid #d5d9e0; border-radius:8px; background:#fff; font-size:14px;
    }
    .btn { padding:8px 12px; border:1px solid #cbd5e1; background:#fff; border-radius:8px; cursor:pointer; }
    .btn.primary { background:#2563eb; border-color:#2563eb; color:#fff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn.sm { padding:4px 8px; font-size:12.5px; }
    .bar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .muted { color:#667085; font-size:12.5px; }
    .warn { color:#b91c1c; font-size:12px; }

    /* —Ç–∞–±–ª–∏—Ü—è */
    table { width:100%; border-collapse:collapse; table-layout: fixed; }
    th, td { border:1px solid #e5e7eb; padding:6px 8px; font-size:13px; text-align:left; vertical-align: top; }
    th { background:#f1f5f9; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }

    .pill { background:#eef2ff; color:#3730a3; padding:2px 8px; border-radius:999px; font-size:12px; }
    .stats { display:flex; gap:12px; flex-wrap:wrap; font-size:13px; color:#111827; }
    .stats .chip { background:#f3f4f6; border:1px solid #e5e7eb; border-radius:999px; padding:4px 10px; }

    /* —à–∞–ø–∫–∞ */
    header.top { background:#2563eb;color:#fff;padding:10px;display:flex;gap:16px;align-items:center;justify-content:space-between; }
    header.top a { color:#fff;text-decoration:none; }
    .authbar { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .authbar input { height:30px; padding:4px 8px; border-radius:6px; border:1px solid rgba(255,255,255,.35); background:#fff; color:#111; }
    .authbar .btn { height:30px; padding:4px 10px; }
    .role-badge { background:rgba(255,255,255,.2); padding:2px 8px; border-radius:999px; font-size:12px; }

    /* –∫–∞—Ä—Ç–∫–∞ –∑ —Ç–∞–±–ª–∏—Ü–µ—é –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
    .card.edge { width: 100vw; margin-left: calc(50% - 50vw); margin-right: calc(50% - 50vw); border-radius: 0; }

    /* —à–∏—Ä–∏–Ω–∏/–ø–æ–≤–µ–¥—ñ–Ω–∫–∞ –∫–æ–º—ñ—Ä–æ–∫ */
    .col-code { width: 120px; }
    .cell-code { word-break: break-all; overflow-wrap: anywhere; white-space: normal; line-height:1.25; }

    .col-id { width: clamp(120px, 18vw, 220px); }
    .cell-id { position:relative; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right:28px; }
    .copy-id { position:absolute; right:6px; top:50%; transform:translateY(-50%); border:0; background:transparent; cursor:pointer; font-size:14px; opacity:.75; }
    .copy-id:hover { opacity:1; }
  </style>
</head>
<body>
<header class="top">
  <nav style="display:flex;gap:16px;align-items:center;">
    <a href="/">üè† –ö–∞—Ä—Ç–∞</a>
    <a href="/export/">üì§ –ï–∫—Å–ø–æ—Ä—Ç</a>
    <a href="/import/">üì• –Ü–º–ø–æ—Ä—Ç</a>
  </nav>
  <div class="authbar">
    <span id="authInfo">–ù–µ —É–≤—ñ–π—à–ª–∏</span>
    <span id="authRole" class="role-badge" style="display:none;"></span>
    <input id="authEmail" type="text" placeholder="email (–Ω–∞–ø—Ä. user@demo.fake)" autocomplete="username" />
    <input id="authPass" type="password" placeholder="–ø–∞—Ä–æ–ª—å" autocomplete="current-password" />
    <button id="btnLogin" class="btn">–£–≤—ñ–π—Ç–∏</button>
    <button id="btnLogout" class="btn" style="display:none;">–í–∏–π—Ç–∏</button>
    <span id="status" class="pill">–ó‚Äô—î–¥–Ω–∞–Ω–Ω—è‚Ä¶</span>
  </div>
</header>

  <div class="wrap">
    <div class="topbar">
      <h1>–ï–∫—Å–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç—ñ–≤ (Firestore ‚Üí Excel)</h1>
      <div class="bar"><a class="btn" href="/index.html">‚Üê –î–æ –∫–∞—Ä—Ç–∏</a></div>
    </div>

    <div class="card" style="margin-bottom:12px;">
      <div class="row cols-2">
        <div>
          <label>–§—ñ–ª—å—Ç—Ä: –í—ñ–¥</label>
          <input id="fromName" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏..." list="directoryList" autocomplete="off">
        </div>
        <div>
          <label>–§—ñ–ª—å—Ç—Ä: –î–æ</label>
          <input id="toName" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏..." list="directoryList" autocomplete="off">
        </div>
      </div>

      <div class="row cols-2" style="margin-top:12px;">
        <div>
          <label>–¢–∏–ø</label>
          <select id="routeType">
            <option value="">‚Äî –±—É–¥—å-—è–∫–∏–π ‚Äî</option>
            <option value="–û—Å–Ω–æ–≤–Ω–∏–π">–û—Å–Ω–æ–≤–Ω–∏–π</option>
            <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1</option>
            <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2</option>
          </select>
        </div>
        <div>
          <label>–û–Ω–æ–≤–ª–µ–Ω–æ: –∑ ‚Üí –ø–æ</label>
          <div class="row dates">
            <input id="dateFrom" type="date">
            <input id="dateTo" type="date">
          </div>
        </div>
      </div>

      <div class="row cols-4" style="margin-top:12px;">
        <div>
          <label>–í–∏—Ä–æ–±–Ω–∏—á–∏–π –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª (—É –í—ñ–¥ –∞–±–æ –î–æ)</label>
          <select id="unitFilter"><option value="">‚Äî –±—É–¥—å-—è–∫–∏–π ‚Äî</option></select>
        </div>
        <div>
          <label>–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º ‚Äî –≤—ñ–¥</label>
          <input id="distMin" type="number" step="0.001" placeholder="–º—ñ–Ω.">
        </div>
        <div>
          <label>–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º ‚Äî –¥–æ</label>
          <input id="distMax" type="number" step="0.001" placeholder="–º–∞–∫—Å.">
        </div>
        <div>
          <label>–õ–æ–≥—ñ—Å—Ç</label>
          <input id="logistFilter" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏..." list="logistsList" autocomplete="off">
          <datalist id="logistsList"></datalist>
          <div id="logistsMsg" class="warn" style="display:none;margin-top:4px"></div>
        </div>
      </div>

      <div class="bar" style="margin-top:12px;">
        <button id="btnPreview" class="btn" disabled>üëÅÔ∏è –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥</button>
        <button id="btnExport" class="btn primary" disabled>üì• –ï–∫—Å–ø–æ—Ä—Ç —É Excel</button>
        <span class="muted">–ü–æ—Ä–æ–∂–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ = –Ω–µ –æ–±–º–µ–∂—É–≤–∞—Ç–∏. –Ø–∫—â–æ Firestore –ø–æ–ø—Ä–æ—Å–∏—Ç—å —ñ–Ω–¥–µ–∫—Å ‚Äî —Å—Ç–≤–æ—Ä—ñ—Ç—å, –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º —ñ–∑ –∫–æ–Ω—Å–æ–ª—ñ.</span>
      </div>
      <datalist id="directoryList"></datalist>
    </div>

    <div class="card edge">
      <div class="bar" style="justify-content:space-between; margin-bottom:8px;">
        <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</strong>
        <span class="muted" id="countInfo">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥¬ª</span>
      </div>

      <div class="stats" id="statsInfo" style="display:none; margin-bottom:8px;">
        <div class="chip" id="statMax">–ù–∞–π–±—ñ–ª—å—à–∞: ‚Äî</div>
        <div class="chip" id="statMin">–ù–∞–π–º–µ–Ω—à–∞: ‚Äî</div>
        <div class="chip" id="statAvg">–°–µ—Ä–µ–¥–Ω—è: ‚Äî</div>
      </div>

      <div style="overflow:auto;">
        <table id="resTable">
          <colgroup>
            <col class="col-code"><col class="col-code">
            <col><col><col><col><col><col>
            <col class="col-id">
            <col><col>
          </colgroup>
          <thead>
            <tr>
              <th>–ö–æ–¥ –í—ñ–¥</th><th>–ö–æ–¥ –î–æ</th>
              <th>–í—ñ–¥</th><th>–î–æ</th>
              <th>–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º</th><th>–¢–∏–ø</th>
              <th>–õ–æ–≥—ñ—Å—Ç</th>
              <th>–û–Ω–æ–≤–ª–µ–Ω–æ</th><th>ID</th>
              <th>–ö–∞—Ä—Ç–∞</th>
              <th>–ù–∞–≤—ñ–≥–∞—Ç–æ—Ä</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* === –ù–∞–≤—ñ–≥–∞—Ü—ñ–π–Ω—ñ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏ === */
const MAP_URL = '/index.html';
const NAVIGATE_PAGE = '/navigate.html';
const DEFAULT_PROFILE = 'driving';

/* --- –≥–ª–æ–±–∞–ª—å–Ω–∏–π –ª–æ–≥–µ—Ä --- */
window.addEventListener('error', (e) => {
  console.error('Global error:', e.message, 'at', e.filename, e.lineno);
  try { document.getElementById('status').textContent = '–ü–æ–º–∏–ª–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞'; } catch(_) {}
});

/* ---------- Firebase config ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDjDBZkmy-skuDEQF8-AkRma7yw6TugoQc",
  authDomain: "my-map-app-58312.firebaseapp.com",
  projectId: "my-map-app-58312",
  storageBucket: "my-map-app-58312.firebasestorage.app",
  messagingSenderId: "53260611353",
  appId: "1:53260611353:web:f25e120996ad8305405f88",
  measurementId: "G-9LRX1FLTKL"
};

const statusEl = document.getElementById('status');
let db = null, auth = null;
let currentUser = null;
let currentRole = null;

try{
  const app = firebase.apps?.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  auth = firebase.auth();
  statusEl.textContent = '–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ';
  db.enablePersistence({ synchronizeTabs: true }).catch((e) => {
    console.warn('Persistence off:', e.code || e.message);
  });
} catch(e){
  console.error('Init error:', e);
  statusEl.textContent = '–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó';
}

/* ---------- Auth UI ---------- */
const authInfo = document.getElementById('authInfo');
const authRoleBadge = document.getElementById('authRole');
const btnLogin = document.getElementById('btnLogin');
const btnLogout = document.getElementById('btnLogout');
const emailInp = document.getElementById('authEmail');
const passInp  = document.getElementById('authPass');
const btnPreview = document.getElementById('btnPreview');
const btnExport  = document.getElementById('btnExport');

function setBusy(b){
  btnPreview.disabled = b || !currentUser;
  btnExport.disabled  = b || !currentUser;
  statusEl.textContent = b ? '–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è‚Ä¶' : (currentUser ? '–ì–æ—Ç–æ–≤–æ' : '–£–≤—ñ–π–¥—ñ—Ç—å');
}

btnLogin.addEventListener('click', async () => {
  try{ setBusy(true); await auth.signInWithEmailAndPassword(emailInp.value.trim(), passInp.value); }
  catch(e){ alert('–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: ' + (e?.message || e)); }
  finally{ setBusy(false); }
});
btnLogout.addEventListener('click', async () => { try{ await auth.signOut(); }catch(e){ console.warn(e); } });

auth?.onAuthStateChanged(async (u) => {
  currentUser = u || null;
  if (!u){
    currentRole = null;
    authInfo.textContent = '–ù–µ —É–≤—ñ–π—à–ª–∏';
    authRoleBadge.style.display = 'none';
    btnLogin.style.display = '';
    btnLogout.style.display = 'none';
    setBusy(false);
    return;
  }
  authInfo.textContent = `–£–≤—ñ–π—à–ª–∏ —è–∫ ${u.email || u.uid}`;
  btnLogin.style.display = 'none';
  btnLogout.style.display = '';

  try{
    const rs = await db.collection('roles').doc(u.uid).get();
    currentRole = rs.exists ? (rs.data().role || 'viewer') : 'viewer';
  }catch{ currentRole = 'viewer'; }
  authRoleBadge.textContent = `–†–æ–ª—å: ${currentRole}`;
  authRoleBadge.style.display = '';
  setBusy(false);

  try{ await Promise.all([loadDirectory(), loadLogists(true)]); }catch(e){ console.warn(e); }
});

/* ---------- –î–æ–≤—ñ–¥–Ω–∏–∫ ---------- */
const dirByCode = {}, codeByName = {}; const unitsSet = new Set();
const DIR_CACHE_KEY = 'export.directoryCache.v1';
const DIR_CACHE_TTL_MS = 12 * 60 * 60 * 1000;

function fillDirectoryUI(rows){
  const list = document.getElementById('directoryList');
  const unitSelect = document.getElementById('unitFilter');
  list.innerHTML = '';
  unitSelect.querySelectorAll('option:not([value=""])').forEach(o=>o.remove());
  unitsSet.clear();
  Object.keys(dirByCode).forEach(k=>delete dirByCode[k]);
  Object.keys(codeByName).forEach(k=>delete codeByName[k]);

  for (const r of rows){
    const { code, name, company, unit } = r;
    dirByCode[code] = { name, company, unit };
    if(!(name in codeByName)) codeByName[name]=code;
    if (unit) unitsSet.add(unit);
    const opt = document.createElement('option');
    opt.value = name; opt.label = [name, unit, company].filter(Boolean).join(' ‚Ä¢ ');
    list.appendChild(opt);
  }
  Array.from(unitsSet).sort((a,b)=>a.localeCompare(b,'uk')).forEach(u=>{
    const o=document.createElement('option'); o.value=u; o.textContent=u; unitSelect.appendChild(o);
  });
}

async function loadDirectory(){
  if (!db || !currentUser) return;
  try{
    const raw = localStorage.getItem(DIR_CACHE_KEY);
    if (raw){
      const { ts, rows } = JSON.parse(raw);
      if (Array.isArray(rows) && Date.now() - ts < DIR_CACHE_TTL_MS){ fillDirectoryUI(rows); return; }
    }
  }catch{}
  let snap = null;
  try { snap = await db.collection('directory').get({ source: 'cache' }); } catch {}
  if (!snap || snap.empty) { snap = await db.collection('directory').get(); }
  const rows = [];
  snap.forEach(doc=>{
    const d = doc.data()||{};
    rows.push({ code: doc.id, name: d.name || doc.id, company: d.company || '', unit: d.unit || '' });
  });
  fillDirectoryUI(rows);
  try{ localStorage.setItem(DIR_CACHE_KEY, JSON.stringify({ ts: Date.now(), rows })); }catch{}
}

/* ---------- –õ–æ–≥—ñ—Å—Ç–∏ ---------- */
const logistById = {}, logistIdByName = {};
const LOGISTS_CACHE_KEY = 'export.logistsCache.v1';
const LOGISTS_CACHE_TTL_MS = 12 * 60 * 60 * 1000;
const _norm = s => String(s||'').trim().toLowerCase();

function fillLogistsUI(rows){
  const list = document.getElementById('logistsList');
  list.innerHTML = '';
  for (const k in logistById) delete logistById[k];
  for (const k in logistIdByName) delete logistIdByName[k];
  rows.forEach(r=>{ logistById[r.id]=r; logistIdByName[r.name]=r.id;
    const opt=document.createElement('option'); opt.value=r.name; list.appendChild(opt);
  });
}

async function loadLogists(allowServer){
  const msg = document.getElementById('logistsMsg');
  const show = t => { msg.textContent = t || ''; msg.style.display = t ? 'block' : 'none'; };
  try{
    const raw = localStorage.getItem(LOGISTS_CACHE_KEY);
    if (raw){
      const { ts, rows } = JSON.parse(raw);
      if (Array.isArray(rows) && Date.now() - ts < LOGISTS_CACHE_TTL_MS){ fillLogistsUI(rows); show(''); return; }
    }
    if (!allowServer){ show('–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –ª–æ–≥—ñ—Å—Ç—ñ–≤.'); return; }
    let snap = null;
    try { snap = await db.collection('logists').get({ source: 'default' }); }
    catch(e){
      if (e && (e.code === 'permission-denied' || /insufficient permissions/i.test(e.message))){ show('–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –ª–æ–≥—ñ—Å—Ç—ñ–≤.'); return; }
      throw e;
    }
    let rows = [];
    snap.forEach(doc=>{
      const d = doc.data()||{};
      rows.push({ id: doc.id, name: d.name || doc.id, active: d.active !== false, sort: typeof d.sort === 'number' ? d.sort : 0 });
    });
    rows = rows.filter(r=>r.active).sort((a,b)=>(a.sort-b.sort)||a.name.localeCompare(b.name,'uk'));
    fillLogistsUI(rows);
    try{ localStorage.setItem(LOGISTS_CACHE_KEY, JSON.stringify({ ts: Date.now(), rows })); }catch{}
    show('');
  }catch(e){ console.error('logists load error:', e); show('–ù–µ –≤–¥–∞–ª–æ—Å—å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ª–æ–≥—ñ—Å—Ç—ñ–≤.'); }
}

function getLogistIdByInput(inputId){
  const name = (document.getElementById(inputId).value || '').trim();
  if (!name) return null;
  if (logistIdByName[name]) return logistIdByName[name];
  const n = _norm(name);
  for (const [label, id] of Object.entries(logistIdByName)){ if (_norm(label) === n) return id; }
  const cand = Object.entries(logistIdByName).filter(([label])=> _norm(label).includes(n));
  if (cand.length === 1) return cand[0][1];
  return null;
}

/* ---------- –•–µ–ª–ø–µ—Ä–∏ ---------- */
function getCodeByNameInput(id){ const name=(document.getElementById(id).value||'').trim(); return codeByName[name] || ''; }
function nameByCode(code){ return (dirByCode[code]?.name)||''; }
function unitByCode(code){ return (dirByCode[code]?.unit)||''; }
function dayStartISO(d){ const x=new Date(d); x.setHours(0,0,0,0); return x.toISOString(); }
function dayEndISO(d){ const x=new Date(d); x.setHours(23,59,59,999); return x.toISOString(); }
function formatDate(dt){ if (!dt) return ''; const d=new Date(dt); if (isNaN(d)) return ''; const pad=n=>String(n).padStart(2,'0'); return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }

/* --- –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è —Ç–æ—á–æ–∫ --- */
function toLonLat(p){
  if (Array.isArray(p) && p.length>=2){ const a=Number(p[0]); const b=Number(p[1]); return (Math.abs(a)<=90 && Math.abs(b)<=180)?[b,a]:[a,b]; }
  if (typeof p==='string'){ const parts=p.split(/[;, ]+/).map(Number).filter(v=>!Number.isNaN(v)); if (parts.length>=2) return toLonLat(parts); }
  if (p && typeof p==='object'){ const lat=Number(p.lat ?? p.latitude ?? p.Lat ?? p.Latitude); const lon=Number(p.lon ?? p.lng ?? p.longitude ?? p.Lon ?? p.Lng ?? p.Longitude); if (!Number.isNaN(lat)&&!Number.isNaN(lon)) return [lon,lat]; }
  return null;
}
function normalizePoints(raw){
  if (!raw) return null;
  if (raw.type==='Feature' && raw.geometry?.type==='LineString') return normalizePoints(raw.geometry.coordinates);
  if (raw.geometry?.type==='LineString' && Array.isArray(raw.geometry.coordinates)) return normalizePoints(raw.geometry.coordinates);
  if (raw.type==='FeatureCollection' && Array.isArray(raw.features)){ const f=raw.features.find(f=>f.geometry?.type==='LineString'); if (f) return normalizePoints(f.geometry.coordinates); }
  if (Array.isArray(raw)){ const out=[]; for (const item of raw){ const pt=toLonLat(item); if (pt && Number.isFinite(pt[0]) && Number.isFinite(pt[1])) out.push(pt); } return out.length?out:null; }
  return null;
}

/* === UTF-8 Base64 === */
function b64encodeUtf8(objOrString){
  const s = typeof objOrString === 'string' ? objOrString : JSON.stringify(objOrString);
  const bytes = new TextEncoder().encode(s); let bin='';
  for (let i=0;i<bytes.length;i++) bin += String.fromCharCode(bytes[i]); return btoa(bin);
}

/* –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç */
const round6 = n => Math.round(n * 1e6) / 1e6;
const roundCoords = arr => (arr || []).map(([lng,lat]) => [round6(lng), round6(lat)]);

/* –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–æ–º–∞–ª—å–æ–≤–∞–Ω–∏—Ö —Å–µ–≥–º–µ–Ω—Ç—ñ–≤ */
function normalizeSegments(source){
  const segments=[];
  function pushLine(arr){ if (!Array.isArray(arr)) return; const pts=arr.map(toLonLat).filter(Boolean); if (pts.length>=2) segments.push(pts); }
  function scan(val){
    if (!val) return;
    if (val.type==='FeatureCollection' && Array.isArray(val.features)){ val.features.forEach(f=>{ if (f?.geometry?.type==='LineString') pushLine(f.geometry.coordinates); if (f?.geometry?.type==='MultiLineString') (f.geometry.coordinates||[]).forEach(pushLine); }); return; }
    if (val.type==='Feature' && val.geometry) return scan(val.geometry);
    if (val.type==='LineString' && Array.isArray(val.coordinates)) return pushLine(val.coordinates);
    if (val.type==='MultiLineString' && Array.isArray(val.coordinates)) return val.coordinates.forEach(pushLine);
    if (Array.isArray(val)){ if (val.length && Array.isArray(val[0])) return pushLine(val); if (val.length && typeof val[0]==='object'){ const pts=val.map(toLonLat).filter(Boolean); if (pts.length>=2) return segments.push(pts); val.forEach(scan); return; } if (val.length && typeof val[0]==='string') return pushLine(val); }
    if (typeof val==='object'){ for (const [k,v] of Object.entries(val)){ if (/(ruler|manual|line|path|segment|polyline|draw)/i.test(k)) scan(v); } }
  }
  scan(source); return segments;
}

/* --- –º–µ–º–æ —Å—Ç–∞–Ω –≤–∏–±—ñ—Ä–∫–∏ --- */
let lastQueryKey = ''; let lastAllRows = null;

function getFiltersSignature(){
  const fromCode = getCodeByNameInput('fromName');
  const toCode   = getCodeByNameInput('toName');
  const type     = document.getElementById('routeType')?.value || '';
  const df       = document.getElementById('dateFrom')?.value || '';
  const dt       = document.getElementById('dateTo')?.value || '';
  const unit     = document.getElementById('unitFilter')?.value || '';
  const dmin     = document.getElementById('distMin')?.value || '';
  const dmax     = document.getElementById('distMax')?.value || '';
  const logist   = document.getElementById('logistFilter')?.value || '';
  return JSON.stringify({ fromCode, toCode, type, df, dt, unit, dmin, dmax, logist });
}

/* ---------- –í–∏–±—ñ—Ä–∫–∞ –∑ Firestore ---------- */
const ROUTES_LIMIT = 1000;

async function queryRoutes(){
  if (!db || !currentUser) throw new Error('–ù–µ–æ–±—Ö—ñ–¥–Ω–æ —É–≤—ñ–π—Ç–∏');

  let q = db.collection('routes');
  const fromCode = getCodeByNameInput('fromName');
  const toCode   = getCodeByNameInput('toName');
  const type     = document.getElementById('routeType')?.value;
  const df       = document.getElementById('dateFrom')?.value;
  const dt       = document.getElementById('dateTo')?.value;

  const logistId = getLogistIdByInput('logistFilter');

  if (fromCode) q = q.where('fromCode','==',fromCode);
  if (toCode)   q = q.where('toCode','==',toCode);
  if (type)     q = q.where('routeType','==',type);
  if (logistId) q = q.where('logisticId','==',logistId);

  q = q.orderBy('updatedAt','desc');
  if (df) q = q.where('updatedAt','>=', dayStartISO(df));
  if (dt) q = q.where('updatedAt','<=', dayEndISO(dt));

  let snap = null;
  try { snap = await q.limit(ROUTES_LIMIT).get({ source: 'cache' }); } catch {}
  if (!snap || snap.empty) { snap = await q.limit(ROUTES_LIMIT).get(); }

  const rows=[];
  snap.forEach(doc=>{
    const d=doc.data()||{};
    rows.push({
      id: doc.id,
      fromCode: d.fromCode||'',
      toCode: d.toCode||'',
      fromName: nameByCode(d.fromCode)||'',
      toName: nameByCode(d.toCode)||'',
      fromUnit: unitByCode(d.fromCode)||'',
      toUnit: unitByCode(d.toCode)||'',
      distance_km: (typeof d.distance_km==='number')? d.distance_km : NaN,
      type: d.routeType||'',
      logisticName: d.logisticName || '',
      logisticId: d.logisticId || '',
      updatedAtRaw: d.updatedAt || null,
      updatedAt: formatDate(d.updatedAt)
    });
  });
  return rows;
}

async function getFilteredRows(){
  const key = getFiltersSignature();
  if (lastAllRows && key === lastQueryKey){ return applyClientFilters(lastAllRows); }
  const all = await queryRoutes(); lastQueryKey = key; lastAllRows = all; return applyClientFilters(all);
}

/* ---------- –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ ---------- */
function applyClientFilters(rows){
  const unit = document.getElementById('unitFilter')?.value.trim() || '';
  const dmin = parseFloat(document.getElementById('distMin')?.value);
  const dmax = parseFloat(document.getElementById('distMax')?.value);
  const logistText = (document.getElementById('logistFilter')?.value || '').trim();
  const logistId = getLogistIdByInput('logistFilter');

  return rows.filter(r=>{
    if (unit && !(r.fromUnit === unit || r.toUnit === unit)) return false;
    const dist = r.distance_km;
    if (!Number.isFinite(dist)) return false;
    if (!Number.isNaN(dmin) && isFinite(dmin) && dist < dmin) return false;
    if (!Number.isNaN(dmax) && isFinite(dmax) && dist > dmax) return false;
    if (logistText && !logistId) {
      const n = _norm(logistText);
      if (!_norm(r.logisticName).includes(n)) return false;
    }
    return true;
  });
}

/* ---------- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ---------- */
function updateStats(rows){
  const statsBox = document.getElementById('statsInfo');
  if (!rows.length){ statsBox.style.display='none'; return; }
  const nums = rows.map(r=>r.distance_km).filter(Number.isFinite);
  if (!nums.length){ statsBox.style.display='none'; return; }
  const max = Math.max(...nums), min = Math.min(...nums), avg = nums.reduce((a,b)=>a+b,0)/nums.length;
  document.getElementById('statMax').textContent = `–ù–∞–π–±—ñ–ª—å—à–∞: ${max.toFixed(3)}`;
  document.getElementById('statMin').textContent = `–ù–∞–π–º–µ–Ω—à–∞: ${min.toFixed(3)}`;
  document.getElementById('statAvg').textContent = `–°–µ—Ä–µ–¥–Ω—è: ${avg.toFixed(3)}`;
  statsBox.style.display='';
}

/* ---------- –ù–∞–≤—ñ–≥–∞—Ç–æ—Ä ---------- */
async function buildNavigatePayloadById(routeId, prettyName){
  const ref = db.collection('routes').doc(routeId);
  const doc = await ref.get();
  if (!doc.exists) throw new Error('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
  const d = doc.data() || {};

  let points =
      normalizePoints(d.points) ||
      normalizePoints(d.coordinates) ||
      normalizePoints(d.route) ||
      normalizePoints(d.geojson) ||
      normalizePoints(d.geometry);

  if (!points) {
    const parts = [];
    if (d.start) { const p = toLonLat(d.start); if (p) parts.push(p); }
    if (Array.isArray(d.midpoints)) for (const m of d.midpoints){ const p=toLonLat(m); if (p) parts.push(p); }
    if (d.end) { const p = toLonLat(d.end); if (p) parts.push(p); }
    if (parts.length >= 2) points = parts;
  }
  if (!points || points.length < 2) throw new Error('–£ –º–∞—Ä—à—Ä—É—Ç—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –º–∞—Å–∏–≤ —Ç–æ—á–æ–∫');

  const manualSegments = normalizeSegments(d);
  return { name: prettyName || '–ú–∞—Ä—à—Ä—É—Ç', points: roundCoords(points), manualSegments: (manualSegments || []).map(roundCoords) };
}

function buildNavigateURLFromPayload(payloadObj){
  const base = `${location.origin}${NAVIGATE_PAGE}`;
  const q = new URLSearchParams();
  try { const json = JSON.stringify(payloadObj); const srcz = LZString.compressToEncodedURIComponent(json); q.set('srcz', srcz); } catch(e){ console.warn('Compression failed:', e); }
  try { q.set('src', b64encodeUtf8(payloadObj)); } catch(e){}
  return `${base}?${q.toString()}`;
}

function isMobileUA(){ return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent || ''); }
async function shareURL(url, title){
  if (isMobileUA() && navigator.share){ try { await navigator.share({ title: title || '–ú–∞—Ä—à—Ä—É—Ç', url }); return; } catch{} }
  try { await navigator.clipboard.writeText(url); alert('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ —É –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É!'); }
  catch { prompt('–°–∫–æ–ø—ñ—é–π—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –≤—Ä—É—á–Ω—É:', url); }
}

/* ---------- –¢–∞–±–ª–∏—Ü—è ---------- */
function renderTable(rows){
  const tb = document.querySelector('#resTable tbody');
  tb.innerHTML = rows.map(r=>`<tr data-id="${r.id}">
    <td class="cell-code" title="${r.fromCode}">${r.fromCode}</td>
    <td class="cell-code" title="${r.toCode}">${r.toCode}</td>
    <td>${r.fromName}</td>
    <td>${r.toName}</td>
    <td>${Number.isFinite(r.distance_km) ? r.distance_km.toFixed(3) : ''}</td>
    <td>${r.type}</td>
    <td>${r.logisticName || ''}</td>
    <td>${r.updatedAt}</td>
    <td class="cell-id" title="${r.id}">
      ${r.id}
      <button class="copy-id" data-id="${r.id}" title="–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ ID">üìã</button>
    </td>
    <td><a href="${MAP_URL}?rid=${encodeURIComponent(r.id)}" target="_blank" rel="noopener">–í—ñ–¥–∫—Ä–∏—Ç–∏</a></td>
    <td><button class="btn sm share-btn" data-id="${r.id}" data-name="${(r.fromName||'') + ' ‚Üí ' + (r.toName||'')}">üîó –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è</button></td>
  </tr>`).join('');
  document.getElementById('countInfo').textContent = `–ó–∞–ø–∏—Å—ñ–≤ (–ø—ñ—Å–ª—è —Ñ—ñ–ª—å—Ç—Ä—É): ${rows.length}`;
  updateStats(rows);
}

/* ---------- –ï–∫—Å–ø–æ—Ä—Ç —É Excel ---------- */
function exportToExcel(rows){
  const data = [
    ['–ö–æ–¥ –í—ñ–¥','–ö–æ–¥ –î–æ','–í—ñ–¥','–î–æ','–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º','–¢–∏–ø','–õ–æ–≥—ñ—Å—Ç','–û–Ω–æ–≤–ª–µ–Ω–æ','ID','URL (–ö–∞—Ä—Ç–∞)'],
    ...rows.map(r => [
      r.fromCode, r.toCode, r.fromName, r.toName,
      Number.isFinite(r.distance_km) ? Number(r.distance_km.toFixed(3)) : '',
      r.type, r.logisticName || '', r.updatedAt, r.id,
      `${location.origin}${MAP_URL}?rid=${encodeURIComponent(r.id)}`
    ])
  ];
  const ws = XLSX.utils.aoa_to_sheet(data);
  ws['!cols'] = [12,12,28,28,12,16,22,22,36,40].map(w => ({ wch: w }));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '–ú–∞—Ä—à—Ä—É—Ç–∏');
  XLSX.writeFile(wb, 'routes_export.xlsx');
}

/* ---------- –ü–æ–º–∏–ª–∫–∏ Firestore ---------- */
function handleFirestoreError(e){
  console.error('Firestore error:', e);
  const msg = e?.message || '';
  if (e?.code === 'failed-precondition' && msg.includes('create it here')) {
    const m = msg.match(/https:\/\/console\.firebase\.google\.com\/[^\s"]+/);
    if (m && m[0]) { const url = m[0]; try { window.open(url, '_blank'); } catch(_) {} alert('–î–ª—è —Ü—å–æ–≥–æ –∑–∞–ø–∏—Ç—É –ø–æ—Ç—Ä—ñ–±–µ–Ω —ñ–Ω–¥–µ–∫—Å —É Firestore.\n–Ø –≤—ñ–¥–∫—Ä–∏–≤ —Å—Ç–æ—Ä—ñ–Ω–∫—É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—É —É –Ω–æ–≤—ñ–π –≤–∫–ª–∞–¥—Ü—ñ.\n\n–ü–æ—Å–∏–ª–∞–Ω–Ω—è:\n' + url); return; }
  }
  alert(msg || e);
}

/* ---------- –ü–æ–¥—ñ—ó ---------- */
btnPreview.addEventListener('click', async ()=>{
  try{ setBusy(true); const rows = await getFilteredRows(); renderTable(rows); }
  catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

btnExport.addEventListener('click', async ()=>{
  try{ setBusy(true); const rows = await getFilteredRows(); exportToExcel(rows); }
  catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

/* –î–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è –∫–ª—ñ–∫—ñ–≤: –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è + –ö–æ–ø—ñ—é–≤–∞—Ç–∏ ID */
document.querySelector('#resTable tbody').addEventListener('click', async (ev)=>{
  const shareBtn = ev.target.closest('.share-btn');
  if (shareBtn){
    const id = shareBtn.getAttribute('data-id');
    const prettyName = shareBtn.getAttribute('data-name') || '–ú–∞—Ä—à—Ä—É—Ç';
    try{
      setBusy(true);
      const payload = await buildNavigatePayloadById(id, prettyName);
      const url = buildNavigateURLFromPayload(payload);
      await shareURL(url, prettyName);
    }catch(e){ alert('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –Ω–∞–≤—ñ–≥–∞—Ç–æ—Ä–∞: ' + (e?.message || e)); }
    finally{ setBusy(false); }
    return;
  }

  const copyBtn = ev.target.closest('.copy-id');
  if (copyBtn){
    const id = copyBtn.getAttribute('data-id') || '';
    try{
      await navigator.clipboard.writeText(id);
      copyBtn.textContent = '‚úÖ';
      setTimeout(()=>{ copyBtn.textContent = 'üìã'; }, 1000);
    }catch{ prompt('–°–∫–æ–ø—ñ—é–π—Ç–µ ID –≤—Ä—É—á–Ω—É:', id); }
  }
});

/* ---------- –°—Ç–∞—Ä—Ç ---------- */
(async ()=>{
  if (!db) return;
  statusEl.textContent = '–£–≤—ñ–π–¥—ñ—Ç—å';
  if (auth?.currentUser) { await Promise.all([loadDirectory(), loadLogists(true)]); }
  else { await loadLogists(false); }
})();

/* ============================================================
   –û–†–ò–ì–Ü–ù–ê–õ–¨–ù–ò–ô –ö–û–î –ú–ê–†–®–†–£–¢–£ (–¥–ª—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É)
   –ü—Ä–∏–∫–ª–∞–¥: –ì–∞–π—Å–∏–Ω ‚Üí –¢—Ä–æ—â–∞ => "–ì-–¢-XXXXXXXXXX"
   ============================================================ */

/** –ü–æ–≤–µ—Ä—Ç–∞—î –ø–µ—Ä—à—É –ª—ñ—Ç–µ—Ä—É –∑ —Ä—è–¥–∫–∞ (–±–µ–∑ –ø—Ä–æ–±—ñ–ª—ñ–≤), —É –≤–µ—Ä—Ö–Ω—å–æ–º—É —Ä–µ–≥—ñ—Å—Ç—Ä—ñ */
function _firstLetter(s){
  const t = String(s||'').trim();
  return t ? t[0].toUpperCase() : 'X';
}

/** –ì–µ–Ω–µ—Ä—É—î —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É —ñ –±—Ä–æ–Ω—é—î –π–æ–≥–æ –≤ Firestore (–∫–æ–ª–µ–∫—Ü—ñ—è routeKeys) */
async function mintRouteKey(fromName, toName){
  const prefix = `${_firstLetter(fromName)}-${_firstLetter(toName)}-`;
  while(true){
    const rnd = Math.floor(Math.random() * 1e10).toString().padStart(10,'0'); // 10 —Ü–∏—Ñ—Ä
    const key = prefix + rnd;
    const ref = db.collection('routeKeys').doc(key);
    try{
      await db.runTransaction(async tx=>{
        const snap = await tx.get(ref);
        if (snap.exists) throw new Error('exists');
        tx.set(ref, { createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      });
      return key; // —É—Å–ø—ñ—à–Ω–æ –∑–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω–æ
    }catch(e){
      if (e.message !== 'exists') console.warn('mintRouteKey retry:', e.message||e);
      // –∫–æ–ª—ñ–∑—ñ—è –∞–±–æ —ñ–Ω—à–∞ –ø–æ–º–∏–ª–∫–∞ ‚Äî –ø—Ä–æ–±—É—î–º–æ —â–µ —Ä–∞–∑
    }
  }
}

/* –ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è (–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É):
async function createRoute({ fromCode, toCode, ...rest }){
  const fromName = nameByCode(fromCode);
  const toName   = nameByCode(toCode);
  const routeKey = await mintRouteKey(fromName, toName); // –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ "–ì-–¢-0123456789"
  await db.collection('routes').add({
    fromCode, toCode,
    routeKey,            // –∑–±–µ—Ä—ñ–≥–∞—î–º–æ "–æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∫–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É"
    ...rest,
    updatedAt: new Date().toISOString()
  });
}
*/
</script>
</body>
</html>
