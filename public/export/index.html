<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>–ï–∫—Å–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç—ñ–≤ (Firestore ‚Üí Excel)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- SheetJS (Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- LZ-String (srcz) -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

  <style>
    :root { --w: 1080px; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f6f7f9; }
    .wrap { max-width:var(--w); margin:24px auto; padding:0 16px; }
    .card { background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.06); padding:16px; }
    h1 { margin:0 0 12px; font-size:20px; }

    .row { display:grid; gap:12px; }
    .row.cols-2 { grid-template-columns: 1fr 1fr; }
    .row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
    .row.cols-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
    .row.dates { grid-template-columns: minmax(180px,1fr) minmax(180px,1fr); gap:10px; }
    @media (max-width: 860px) { .row.cols-4 { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 640px) { .row.cols-2, .row.cols-3, .row.cols-4, .row.dates { grid-template-columns: 1fr; } }

    label { display:block; font-size:13px; color:#555; margin:4px 0; }
    input[type="text"], input[type="date"], input[type="number"], select {
      width:100%; padding:8px 10px; border:1px solid #d5d9e0; border-radius:8px; background:#fff; font-size:14px;
    }
    .btn { padding:8px 12px; border:1px solid #cbd5e1; background:#fff; border-radius:8px; cursor:pointer; }
    .btn.primary { background:#2563eb; border-color:#2563eb; color:#fff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn.sm { padding:4px 8px; font-size:12.5px; }
    .bar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .muted { color:#667085; font-size:12.5px; }
    .warn { color:#b91c1c; font-size:12px; }

    /* —Ç–∞–±–ª–∏—Ü—è */
    table { width:100%; border-collapse:collapse; table-layout: fixed; }
    th, td { border:1px solid #e5e7eb; padding:6px 8px; font-size:13px; text-align:left; vertical-align: top; }
    th { background:#f1f5f9; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }

    .pill { background:#eef2ff; color:#3730a3; padding:2px 8px; border-radius:999px; font-size:12px; }
    .stats { display:flex; gap:12px; flex-wrap:wrap; font-size:13px; color:#111827; }
    .stats .chip { background:#f3f4f6; border:1px solid #e5e7eb; border-radius:999px; padding:4px 10px; }

    /* —à–∞–ø–∫–∞ */
    header.top { background:#2563eb;color:#fff;padding:10px;display:flex;gap:16px;align-items:center;justify-content:space-between; }
    header.top a { color:#fff;text-decoration:none; }
    .authbar { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .authbar .btn { height:30px; padding:4px 10px; }
    .role-badge { background:rgba(255,255,255,.2); padding:2px 8px; border-radius:999px; font-size:12px; }

    /* –∫–∞—Ä—Ç–∫–∞ –∑ —Ç–∞–±–ª–∏—Ü–µ—é –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
    .card.edge { width: 100vw; margin-left: calc(50% - 50vw); margin-right: calc(50% - 50vw); border-radius: 0; }

    /* —à–∏—Ä–∏–Ω–∏/–ø–æ–≤–µ–¥—ñ–Ω–∫–∞ –∫–æ–º—ñ—Ä–æ–∫ */
    .col-code { width: 120px; }
    .cell-code { word-break: break-all; overflow-wrap: anywhere; white-space: normal; line-height:1.25; }

    .col-key { width: clamp(140px, 16vw, 200px); }
    .col-id  { width: clamp(120px, 18vw, 220px); }

    .cell-key, .cell-id { position:relative; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right:28px; }
    .copy-btn { position:absolute; right:6px; top:50%; transform:translateY(-50%); border:0; background:transparent; cursor:pointer; font-size:14px; opacity:.75; }
    .copy-btn:hover { opacity:1; }

    /* —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è / —Ñ—ñ–ª—å—Ç—Ä–∏ –≤ —à–∞–ø—Ü—ñ */
    th.sortable { cursor:pointer; user-select:none; position:relative; }
    th.sortable .s { font-size:11px; opacity:.6; margin-left:6px; }
    th.sortable.active .s { opacity:1; }
    thead tr.filters th { background:#fafafa; }
    thead tr.filters input, thead tr.filters select {
      width:100%; padding:4px 6px; border:1px solid #e5e7eb; border-radius:6px; font-size:12px; background:#fff;
    }
    .range { display:grid; grid-template-columns: 1fr 1fr; gap:6px; }
  </style>
</head>
<body>
<header class="top">
  <nav style="display:flex;gap:16px;align-items:center;">
    <a href="/">üè† –ö–∞—Ä—Ç–∞</a>
    <a href="/export/">üì§ –ï–∫—Å–ø–æ—Ä—Ç</a>
    <a href="/import/">üì• –Ü–º–ø–æ—Ä—Ç</a>
  </nav>
  <div class="authbar">
    <span id="authInfo">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞‚Ä¶</span>
    <span id="authRole" class="role-badge" style="display:none;"></span>
    <button id="btnLogout" class="btn" style="display:none;">–í–∏–π—Ç–∏</button>
    <span id="status" class="pill">–ó‚Äô—î–¥–Ω–∞–Ω–Ω—è‚Ä¶</span>
  </div>
</header>

  <div class="wrap">
    <div class="topbar">
      <h1>–ï–∫—Å–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç—ñ–≤ (Firestore ‚Üí Excel)</h1>
      <div class="bar"><a class="btn" href="/index.html">‚Üê –î–æ –∫–∞—Ä—Ç–∏</a></div>
    </div>

    <div class="card" style="margin-bottom:12px;">
      <div class="row cols-2">
        <div>
          <label>–§—ñ–ª—å—Ç—Ä: –í—ñ–¥</label>
          <input id="fromName" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏..." list="directoryList" autocomplete="off">
        </div>
        <div>
          <label>–§—ñ–ª—å—Ç—Ä: –î–æ</label>
          <input id="toName" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏..." list="directoryList" autocomplete="off">
        </div>
      </div>

      <div class="row cols-2" style="margin-top:12px;">
        <div>
          <label>–¢–∏–ø</label>
          <select id="routeType">
            <option value="">‚Äî –±—É–¥—å-—è–∫–∏–π ‚Äî</option>
            <option value="–û—Å–Ω–æ–≤–Ω–∏–π">–û—Å–Ω–æ–≤–Ω–∏–π</option>
            <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1</option>
            <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2</option>
          </select>
        </div>
        <div>
          <label>–û–Ω–æ–≤–ª–µ–Ω–æ: –∑ ‚Üí –ø–æ</label>
          <div class="row dates">
            <input id="dateFrom" type="date">
            <input id="dateTo" type="date">
          </div>
        </div>
      </div>

      <div class="row cols-4" style="margin-top:12px;">
        <div>
          <label>–í–∏—Ä–æ–±–Ω–∏—á–∏–π –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª (—É –í—ñ–¥ –∞–±–æ –î–æ)</label>
          <select id="unitFilter"><option value="">‚Äî –±—É–¥—å-—è–∫–∏–π ‚Äî</option></select>
        </div>
        <div>
          <label>–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º ‚Äî –≤—ñ–¥</label>
          <input id="distMin" type="number" step="0.001" placeholder="–º—ñ–Ω.">
        </div>
        <div>
          <label>–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º ‚Äî –¥–æ</label>
          <input id="distMax" type="number" step="0.001" placeholder="–º–∞–∫—Å.">
        </div>
        <div>
          <label>–õ–æ–≥—ñ—Å—Ç</label>
          <input id="logistFilter" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏..." list="logistsList" autocomplete="off">
          <datalist id="logistsList"></datalist>
          <div id="logistsMsg" class="warn" style="display:none;margin-top:4px"></div>
        </div>
      </div>

      <div class="bar" style="margin-top:12px;">
        <button id="btnPreview" class="btn" disabled>üëÅÔ∏è –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥</button>
        <button id="btnExport" class="btn primary" disabled>üì• –ï–∫—Å–ø–æ—Ä—Ç —É Excel</button>
        <button id="btnRefresh" class="btn" disabled>üîÑ –û–Ω–æ–≤–∏—Ç–∏ –±–∞–∑—É</button>
        <span class="muted">–ü–æ—Ä–æ–∂–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ = –Ω–µ –æ–±–º–µ–∂—É–≤–∞—Ç–∏. –Ø–∫—â–æ Firestore –ø–æ–ø—Ä–æ—Å–∏—Ç—å —ñ–Ω–¥–µ–∫—Å ‚Äî —Å—Ç–≤–æ—Ä—ñ—Ç—å, –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º —ñ–∑ –∫–æ–Ω—Å–æ–ª—ñ.</span>
      </div>
      <datalist id="directoryList"></datalist>
    </div>

    <div class="card edge">
      <div class="bar" style="justify-content:space-between; margin-bottom:8px;">
        <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</strong>
        <span class="muted" id="countInfo">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥¬ª</span>
      </div>

      <div class="stats" id="statsInfo" style="display:none; margin-bottom:8px;">
        <div class="chip" id="statMax">–ù–∞–π–±—ñ–ª—å—à–∞: ‚Äî</div>
        <div class="chip" id="statMin">–ù–∞–π–º–µ–Ω—à–∞: ‚Äî</div>
        <div class="chip" id="statAvg">–°–µ—Ä–µ–¥–Ω—è: ‚Äî</div>
      </div>

      <!-- –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è / –¥—ñ—ó -->
      <div class="bar" id="moreBox" style="gap:6px; display:none; margin:6px 0 10px;">
        <button id="btnMore" class="btn sm">+ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —â–µ</button>
        <button id="btnAll" class="btn sm">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—Å–µ</button>
        <button id="btnClearFilters" class="btn sm">–û—á–∏—Å—Ç–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏ —Ç–∞–±–ª–∏—Ü—ñ</button>
      </div>

      <div style="overflow:auto;">
        <table id="resTable">
          <colgroup>
            <col class="col-code"><col class="col-code">
            <col><col><col><col><col><col>
            <col class="col-key">
            <col class="col-id">
            <col><col>
          </colgroup>
          <thead>
            <tr>
              <th class="sortable" data-sort="fromCode">–ö–æ–¥ –í—ñ–¥ <span class="s">‚Üï</span></th>
              <th class="sortable" data-sort="toCode">–ö–æ–¥ –î–æ <span class="s">‚Üï</span></th>
              <th class="sortable" data-sort="fromName">–í—ñ–¥ <span class="s">‚Üï</span></th>
              <th class="sortable" data-sort="toName">–î–æ <span class="s">‚Üï</span></th>
              <th class="sortable" data-sort="distance_km">–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º <span class="s">‚Üï</span></th>
              <th class="sortable" data-sort="type">–¢–∏–ø <span class="s">‚Üï</span></th>
              <th class="sortable" data-sort="logisticName">–õ–æ–≥—ñ—Å—Ç <span class="s">‚Üï</span></th>
              <th class="sortable" data-sort="updatedAtRaw">–û–Ω–æ–≤–ª–µ–Ω–æ <span class="s">‚Üï</span></th>
              <th class="sortable" data-sort="routeKey">–ö–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É <span class="s">‚Üï</span></th>
              <th class="sortable" data-sort="id">ID <span class="s">‚Üï</span></th>
              <th>–ö–∞—Ä—Ç–∞</th>
              <th>–ù–∞–≤—ñ–≥–∞—Ç–æ—Ä</th>
            </tr>
            <!-- –†—è–¥–æ–∫ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ -->
            <tr class="filters">
              <th><input id="f_fromCode" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶"></th>
              <th><input id="f_toCode" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶"></th>
              <th><input id="f_fromName" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶" list="directoryList"></th>
              <th><input id="f_toName" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶" list="directoryList"></th>
              <th>
                <div class="range">
                  <input id="f_distMin" type="number" step="0.001" placeholder="–º—ñ–Ω.">
                  <input id="f_distMax" type="number" step="0.001" placeholder="–º–∞–∫—Å.">
                </div>
              </th>
              <th>
                <select id="f_type">
                  <option value=""></option>
                  <option value="–û—Å–Ω–æ–≤–Ω–∏–π">–û—Å–Ω–æ–≤–Ω–∏–π</option>
                  <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1</option>
                  <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2</option>
                </select>
              </th>
              <th><input id="f_logist" type="text" placeholder="–ª–æ–≥—ñ—Å—Ç‚Ä¶" list="logistsList"></th>
              <th>
                <div class="range">
                  <input id="f_dateFrom" type="date">
                  <input id="f_dateTo" type="date">
                </div>
              </th>
              <th><input id="f_routeKey" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶"></th>
              <th><input id="f_id" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶"></th>
              <th></th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* === –ù–∞–≤—ñ–≥–∞—Ü—ñ–π–Ω—ñ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏ === */
const MAP_URL = '/index.html';
const NAVIGATE_PAGE = '/navigate.html';
const DEFAULT_PROFILE = 'driving';

/* --- –≥–ª–æ–±–∞–ª—å–Ω–∏–π –ª–æ–≥–µ—Ä --- */
window.addEventListener('error', (e) => {
  console.error('Global error:', e.message, 'at', e.filename, e.lineno);
  try { document.getElementById('status').textContent = '–ü–æ–º–∏–ª–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞'; } catch(_) {}
});

/* ---------- Firebase config ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDjDBZkmy-skuDEQF8-AkRma7yw6TugoQc",
  authDomain: "my-map-app-58312.firebaseapp.com",
  projectId: "my-map-app-58312",
  storageBucket: "my-map-app-58312.firebasestorage.app",
  messagingSenderId: "53260611353",
  appId: "1:53260611353:web:f25e120996ad8305405f88",
  measurementId: "G-9LRX1FLTKL"
};

const statusEl = document.getElementById('status');
let db = null, auth = null;
let currentUser = null;
let currentRole = null;

try{
  const app = firebase.apps?.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  auth = firebase.auth();
  statusEl.textContent = '–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ';
  db.enablePersistence({ synchronizeTabs: true }).catch((e) => {
    console.warn('Persistence off:', e.code || e.message);
  });
} catch(e){
  console.error('Init error:', e);
  statusEl.textContent = '–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó';
}

/* ---------- Auth UI ---------- */
const authInfo = document.getElementById('authInfo');
const authRoleBadge = document.getElementById('authRole');
const btnLogout = document.getElementById('btnLogout');
const btnPreview = document.getElementById('btnPreview');
const btnExport  = document.getElementById('btnExport');
const btnRefresh = document.getElementById('btnRefresh');
const btnMore    = document.getElementById('btnMore');
const btnAll     = document.getElementById('btnAll');
const btnClearFilters = document.getElementById('btnClearFilters');

function setBusy(b){
  btnPreview.disabled = b || !currentUser;
  btnExport.disabled  = b || !currentUser;
  btnRefresh.disabled = b || !currentUser;
  if (btnMore) btnMore.disabled = b;
  if (btnAll)  btnAll.disabled  = b;
  if (btnClearFilters) btnClearFilters.disabled = b;
  statusEl.textContent = b ? '–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è‚Ä¶' : (currentUser ? '–ì–æ—Ç–æ–≤–æ' : '–£–≤—ñ–π–¥—ñ—Ç—å');
}

btnLogout.addEventListener('click', async () => { try{ await auth.signOut(); }catch(e){ console.warn(e); } });

auth?.onAuthStateChanged(async (u) => {
  currentUser = u || null;
  if (!u){
    const next = encodeURIComponent(location.pathname + location.search);
    location.replace(`/login.html?next=${next}`);
    return;
  }
  authInfo.textContent = `–£–≤—ñ–π—à–ª–∏ —è–∫ ${u.email || u.uid}`;
  btnLogout.style.display = '';

  try{
    const rs = await db.collection('roles').doc(u.uid).get();
    currentRole = rs.exists ? (rs.data().role || 'viewer') : 'viewer';
  }catch{ currentRole = 'viewer'; }
  authRoleBadge.textContent = `–†–æ–ª—å: ${currentRole}`;
  authRoleBadge.style.display = '';
  setBusy(false);

  try{ await Promise.all([loadDirectory(), loadLogists(true)]); }catch(e){ console.warn(e); }
});

/* ---------- –î–æ–≤—ñ–¥–Ω–∏–∫ ---------- */
const dirByCode = {}, codeByName = {}; const unitsSet = new Set();
const DIR_CACHE_KEY = 'export.directoryCache.v1';
const DIR_CACHE_TTL_MS = 12 * 60 * 60 * 1000;

function fillDirectoryUI(rows){
  const list = document.getElementById('directoryList');
  const unitSelect = document.getElementById('unitFilter');
  list.innerHTML = '';
  unitSelect.querySelectorAll('option:not([value=""])').forEach(o=>o.remove());
  unitsSet.clear();
  Object.keys(dirByCode).forEach(k=>delete dirByCode[k]);
  Object.keys(codeByName).forEach(k=>delete codeByName[k]);

  for (const r of rows){
    const { code, name, company, unit } = r;
    dirByCode[code] = { name, company, unit };
    if(!(name in codeByName)) codeByName[name]=code;
    if (unit) unitsSet.add(unit);
    const opt = document.createElement('option');
    opt.value = name; opt.label = [name, unit, company].filter(Boolean).join(' ‚Ä¢ ');
    list.appendChild(opt);
  }
  Array.from(unitsSet).sort((a,b)=>a.localeCompare(b,'uk')).forEach(u=>{
    const o=document.createElement('option'); o.value=u; o.textContent=u; unitSelect.appendChild(o);
  });
}

async function loadDirectory(forceServer){
  if (!db || !currentUser) return;
  try{
    if (!forceServer){
      const raw = localStorage.getItem(DIR_CACHE_KEY);
      if (raw){
        const { ts, rows } = JSON.parse(raw);
        if (Array.isArray(rows) && Date.now() - ts < DIR_CACHE_TTL_MS){ fillDirectoryUI(rows); return; }
      }
    }
  }catch{}
  let snap = null;
  try {
    snap = await db.collection('directory').get({ source: forceServer ? 'server' : 'cache' });
  } catch {}
  if (!snap || snap.empty) { snap = await db.collection('directory').get({ source: 'default' }); }
  const rows = [];
  snap.forEach(doc=>{
    const d = doc.data()||{};
    rows.push({ code: doc.id, name: d.name || doc.id, company: d.company || '', unit: d.unit || '' });
  });
  fillDirectoryUI(rows);
  try{ localStorage.setItem(DIR_CACHE_KEY, JSON.stringify({ ts: Date.now(), rows })); }catch{}
}

/* ---------- –õ–æ–≥—ñ—Å—Ç–∏ ---------- */
const logistById = {}, logistIdByName = {};
const LOGISTS_CACHE_KEY = 'export.logistsCache.v1';
const LOGISTS_CACHE_TTL_MS = 12 * 60 * 60 * 1000;
const _norm = s => String(s||'').trim().toLowerCase();

function fillLogistsUI(rows){
  const list = document.getElementById('logistsList');
  list.innerHTML = '';
  for (const k in logistById) delete logistById[k];
  for (const k in logistIdByName) delete logistIdByName[k];
  rows.forEach(r=>{ logistById[r.id]=r; logistIdByName[r.name]=r.id;
    const opt=document.createElement('option'); opt.value=r.name; list.appendChild(opt);
  });
}

async function loadLogists(allowServer){
  const msg = document.getElementById('logistsMsg');
  const show = t => { msg.textContent = t || ''; msg.style.display = t ? 'block' : 'none'; };
  try{
    const raw = localStorage.getItem(LOGISTS_CACHE_KEY);
    if (raw){
      const { ts, rows } = JSON.parse(raw);
      if (Array.isArray(rows) && Date.now() - ts < LOGISTS_CACHE_TTL_MS){ fillLogistsUI(rows); show(''); return; }
    }
    if (!allowServer){ show('–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –ª–æ–≥—ñ—Å—Ç—ñ–≤.'); return; }
    let snap = null;
    try { snap = await db.collection('logists').get({ source: 'server' }); }
    catch(e){
      if (e && (e.code === 'permission-denied' || /insufficient permissions/i.test(e.message))){ show('–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –ª–æ–≥—ñ—Å—Ç—ñ–≤.'); return; }
      throw e;
    }
    let rows = [];
    snap.forEach(doc=>{
      const d = doc.data()||{};
      rows.push({ id: doc.id, name: d.name || doc.id, active: d.active !== false, sort: typeof d.sort === 'number' ? d.sort : 0 });
    });
    rows = rows.filter(r=>r.active).sort((a,b)=>(a.sort-b.sort)||a.name.localeCompare(b.name,'uk'));
    fillLogistsUI(rows);
    try{ localStorage.setItem(LOGISTS_CACHE_KEY, JSON.stringify({ ts: Date.now(), rows })); }catch{}
    show('');
  }catch(e){ console.error('logists load error:', e); show('–ù–µ –≤–¥–∞–ª–æ—Å—å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ª–æ–≥—ñ—Å—Ç—ñ–≤.'); }
}

function getLogistIdByInput(inputId){
  const name = (document.getElementById(inputId).value || '').trim();
  if (!name) return null;
  if (logistIdByName[name]) return logistIdByName[name];
  const n = _norm(name);
  for (const [label, id] of Object.entries(logistIdByName)){ if (_norm(label) === n) return id; }
  const cand = Object.entries(logistIdByName).filter(([label])=> _norm(label).includes(n));
  if (cand.length === 1) return cand[0][1];
  return null;
}

/* ---------- –•–µ–ª–ø–µ—Ä–∏ ---------- */
function getCodeByNameInput(id){ const name=(document.getElementById(id).value||'').trim(); return codeByName[name] || ''; }
function nameByCode(code){ return (dirByCode[code]?.name)||''; }
function unitByCode(code){ return (dirByCode[code]?.unit)||''; }
function dayStartISO(d){ const x=new Date(d); x.setHours(0,0,0,0); return x.toISOString(); }
function dayEndISO(d){ const x=new Date(d); x.setHours(23,59,59,999); return x.toISOString(); }
function formatDate(dt){ if (!dt) return ''; const d=new Date(dt); if (isNaN(d)) return ''; const pad=n=>String(n).padStart(2,'0'); return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
const toNum = v => (v==='' || v==null) ? NaN : Number(v);

/* --- –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è —Ç–æ—á–æ–∫ --- */
function toLonLat(p){
  if (Array.isArray(p) && p.length>=2){ const a=Number(p[0]); const b=Number(p[1]); return (Math.abs(a)<=90 && Math.abs(b)<=180)?[b,a]:[a,b]; }
  if (typeof p==='string'){ const parts=p.split(/[;, ]+/).map(Number).filter(v=>!Number.isNaN(v)); if (parts.length>=2) return toLonLat(parts); }
  if (p && typeof p==='object'){ const lat=Number(p.lat ?? p.latitude ?? p.Lat ?? p.Latitude); const lon=Number(p.lon ?? p.lng ?? p.longitude ?? p.Lon ?? p.Lng ?? p.Longitude); if (!Number.isNaN(lat)&&!Number.isNaN(lon)) return [lon,lat]; }
  return null;
}
function normalizePoints(raw){
  if (!raw) return null;
  if (raw.type==='Feature' && raw.geometry?.type==='LineString') return normalizePoints(raw.geometry.coordinates);
  if (raw.geometry?.type==='LineString' && Array.isArray(raw.geometry.coordinates)) return normalizePoints(raw.geometry.coordinates);
  if (raw.type==='FeatureCollection' && Array.isArray(raw.features)){ const f=raw.features.find(f=>f.geometry?.type==='LineString'); if (f) return normalizePoints(f.geometry.coordinates); }
  if (Array.isArray(raw)){ const out=[]; for (const item of raw){ const pt=toLonLat(item); if (pt && Number.isFinite(pt[0]) && Number.isFinite(pt[1])) out.push(pt); } return out.length?out:null; }
  return null;
}

/* === UTF-8 Base64 === */
function b64encodeUtf8(objOrString){
  const s = typeof objOrString === 'string' ? objOrString : JSON.stringify(objOrString);
  const bytes = new TextEncoder().encode(s); let bin='';
  for (let i=0;i<bytes.length;i++) bin += String.fromCharCode(bytes[i]); return btoa(bin);
}

/* –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç */
const round6 = n => Math.round(n * 1e6) / 1e6;
const roundCoords = arr => (arr || []).map(([lng,lat]) => [round6(lng), round6(lat)]);

/* –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–æ–º–∞–ª—å–æ–≤–∞–Ω–∏—Ö —Å–µ–≥–º–µ–Ω—Ç—ñ–≤ */
function normalizeSegments(source){
  const segments=[];
  function pushLine(arr){ if (!Array.isArray(arr)) return; const pts=arr.map(toLonLat).filter(Boolean); if (pts.length>=2) segments.push(pts); }
  function scan(val){
    if (!val) return;
    if (val.type==='FeatureCollection' && Array.isArray(val.features)){ val.features.forEach(f=>{ if (f?.geometry?.type==='LineString') pushLine(f.geometry.coordinates); if (f?.geometry?.type==='MultiLineString') (f.geometry.coordinates||[]).forEach(pushLine); }); return; }
    if (val.type==='Feature' && val.geometry) return scan(val.geometry);
    if (val.type==='LineString' && Array.isArray(val.coordinates)) return pushLine(val.coordinates);
    if (val.type==='MultiLineString' && Array.isArray(val.coordinates)) return val.coordinates.forEach(pushLine);
    if (Array.isArray(val)){ if (val.length && Array.isArray(val[0])) return pushLine(val); if (val.length && typeof val[0]==='object'){ const pts=val.map(toLonLat).filter(Boolean); if (pts.length>=2) return segments.push(pts); val.forEach(scan); return; } if (val.length && typeof val[0]==='string') return pushLine(val); }
    if (typeof val==='object'){ for (const [k,v] of Object.entries(val)){ if (/(ruler|manual|line|path|segment|polyline|draw)/i.test(k)) scan(v); } }
  }
  scan(source); return segments;
}

/* ---------- –ü–ê–ì–Ü–ù–ê–¶–Ü–Ø / –°–¢–ê–ù ---------- */
const PAGE_SIZE = 1000;
let _baseQuery = null;
let _cursor = null;
let _hasMore = false;
let allRows = [];
let FORCE_SERVER = false;

/* ---------- –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è ---------- */
const sortState = { key: 'updatedAtRaw', dir: -1 }; // –¥–µ—Ñ–æ–ª—Ç: –æ–Ω–æ–≤–ª–µ–Ω–æ ‚Üì

/* ---------- –ü–æ–±—É–¥–æ–≤–∞ –∑–∞–ø–∏—Ç—É ---------- */
function buildBaseQuery(){
  if (!db || !currentUser) throw new Error('–ù–µ–æ–±—Ö—ñ–¥–Ω–æ —É–≤—ñ–π—Ç–∏');
  let q = db.collection('routes');

  const fromCode = getCodeByNameInput('fromName');
  const toCode   = getCodeByNameInput('toName');
  const type     = document.getElementById('routeType')?.value;
  const df       = document.getElementById('dateFrom')?.value;
  const dt       = document.getElementById('dateTo')?.value;
  const logistId = getLogistIdByInput('logistFilter');

  if (fromCode) q = q.where('fromCode','==',fromCode);
  if (toCode)   q = q.where('toCode','==',toCode);
  if (type)     q = q.where('routeType','==',type);
  if (logistId) q = q.where('logisticId','==',logistId);

  q = q.orderBy('updatedAt','desc');
  if (df) q = q.where('updatedAt','>=', dayStartISO(df));
  if (dt) q = q.where('updatedAt','<=', dayEndISO(dt));

  return q;
}

function parseSnap(snap){
  const rows=[];
  snap.forEach(doc=>{
    const d=doc.data()||{};
    rows.push({
      id: doc.id,
      routeKey: d.routeKey || '',
      fromCode: d.fromCode||'',
      toCode: d.toCode||'',
      fromName: nameByCode(d.fromCode)||'',
      toName: nameByCode(d.toCode)||'',
      fromUnit: unitByCode(d.fromCode)||'',
      toUnit: unitByCode(d.toCode)||'',
      distance_km: (typeof d.distance_km==='number')? d.distance_km : NaN,
      type: d.routeType||'',
      logisticName: d.logisticName || '',
      logisticId: d.logisticId || '',
      updatedAtRaw: d.updatedAt || null,
      updatedAt: formatDate(d.updatedAt)
    });
  });
  const lastDoc = snap.docs[snap.docs.length-1] || null;
  return { rows, lastDoc };
}

async function loadFirstPage(forceServer=false){
  FORCE_SERVER = !!forceServer;
  _baseQuery = buildBaseQuery();
  _cursor = null; _hasMore = false; allRows = [];
  let snap = null;
  try { snap = await _baseQuery.limit(PAGE_SIZE).get({source: FORCE_SERVER ? 'server' : 'default'}); }
  catch(e){
    console.warn('loadFirstPage fallback:', e?.message||e);
    try { snap = await _baseQuery.limit(PAGE_SIZE).get({source:'cache'}); } catch(_){}
  }
  if (!snap) return [];
  const { rows, lastDoc } = parseSnap(snap);
  allRows = rows;
  _cursor = lastDoc;
  _hasMore = !!lastDoc && snap.size === PAGE_SIZE;
  return rows;
}

async function loadNextPage(){
  if (!_baseQuery || !_cursor) return [];
  let snap = null;
  try { snap = await _baseQuery.startAfter(_cursor).limit(PAGE_SIZE).get({source: FORCE_SERVER ? 'server' : 'default'}); }
  catch(e){
    console.warn('loadNextPage fallback:', e?.message||e);
    try { snap = await _baseQuery.startAfter(_cursor).limit(PAGE_SIZE).get({source:'cache'}); } catch(_){}
  }
  if (!snap) return [];
  const { rows, lastDoc } = parseSnap(snap);
  _cursor = lastDoc;
  _hasMore = !!lastDoc && snap.size === PAGE_SIZE;
  allRows = allRows.concat(rows);
  return rows;
}

/* ---------- –§—ñ–ª—å—Ç—Ä–∏ (–≤–µ—Ä—Ö–Ω—ñ) ---------- */
function applyTopFilters(rows){
  const unit = document.getElementById('unitFilter')?.value.trim() || '';
  const dmin = parseFloat(document.getElementById('distMin')?.value);
  const dmax = parseFloat(document.getElementById('distMax')?.value);
  const logistText = (document.getElementById('logistFilter')?.value || '').trim();
  const logistId = getLogistIdByInput('logistFilter');

  return rows.filter(r=>{
    if (unit && !(r.fromUnit === unit || r.toUnit === unit)) return false;
    const dist = r.distance_km;
    if (!Number.isFinite(dist)) return false;
    if (!Number.isNaN(dmin) && isFinite(dmin) && dist < dmin) return false;
    if (!Number.isNaN(dmax) && isFinite(dmax) && dist > dmax) return false;
    if (logistText && !logistId) {
      const n = _norm(logistText);
      if (!_norm(r.logisticName).includes(n)) return false;
    }
    return true;
  });
}

/* ---------- –§—ñ–ª—å—Ç—Ä–∏ (—Ä—è–¥–æ–∫ —É —à–∞–ø—Ü—ñ —Ç–∞–±–ª–∏—Ü—ñ) ---------- */
function getTableFilterState(){
  return {
    fromCode:  document.getElementById('f_fromCode').value.trim(),
    toCode:    document.getElementById('f_toCode').value.trim(),
    fromName:  document.getElementById('f_fromName').value.trim(),
    toName:    document.getElementById('f_toName').value.trim(),
    distMin:   toNum(document.getElementById('f_distMin').value),
    distMax:   toNum(document.getElementById('f_distMax').value),
    type:      document.getElementById('f_type').value,
    logist:    document.getElementById('f_logist').value.trim(),
    df:        document.getElementById('f_dateFrom').value,
    dt:        document.getElementById('f_dateTo').value,
    routeKey:  document.getElementById('f_routeKey').value.trim(),
    id:        document.getElementById('f_id').value.trim(),
  };
}

function applyTableFilters(rows){
  const f = getTableFilterState();
  const normInc = (val, needle) => _norm(String(val||'')).includes(_norm(needle||''));
  const df = f.df ? new Date(dayStartISO(f.df)) : null;
  const dt = f.dt ? new Date(dayEndISO(f.dt))   : null;

  return rows.filter(r=>{
    if (f.fromCode && !normInc(r.fromCode, f.fromCode)) return false;
    if (f.toCode   && !normInc(r.toCode,   f.toCode))   return false;
    if (f.fromName && !normInc(r.fromName, f.fromName)) return false;
    if (f.toName   && !normInc(r.toName,   f.toName))   return false;
    const dist = r.distance_km;
    if (Number.isFinite(f.distMin) && dist < f.distMin) return false;
    if (Number.isFinite(f.distMax) && dist > f.distMax) return false;
    if (f.type && r.type !== f.type) return false;
    if (f.logist && !normInc(r.logisticName, f.logist)) return false;
    if ((df || dt) && r.updatedAtRaw){
      const d = new Date(r.updatedAtRaw);
      if (df && d < df) return false;
      if (dt && d > dt) return false;
    }
    if (f.routeKey && !normInc(r.routeKey, f.routeKey)) return false;
    if (f.id && !normInc(r.id, f.id)) return false;
    return true;
  });
}

/* ---------- –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –æ–±—á–∏—Å–ª–µ–Ω–Ω—è ---------- */
function compareRows(a,b,key){
  const dir = sortState.dir;
  const getStr = s => String(s||'').toLocaleLowerCase('uk');
  switch(key){
    case 'distance_km': {
      const av = Number.isFinite(a.distance_km) ? a.distance_km : -Infinity;
      const bv = Number.isFinite(b.distance_km) ? b.distance_km : -Infinity;
      return (av - bv) * dir;
    }
    case 'updatedAtRaw': {
      const av = a.updatedAtRaw ? new Date(a.updatedAtRaw).getTime() : 0;
      const bv = b.updatedAtRaw ? new Date(b.updatedAtRaw).getTime() : 0;
      return (av - bv) * dir;
    }
    default: {
      const av = getStr(a[key]);
      const bv = getStr(b[key]);
      const r = av.localeCompare(bv,'uk');
      return r * dir;
    }
  }
}

function sortRows(rows){
  if (!sortState.key) return rows;
  const arr = rows.slice();
  arr.sort((a,b)=>{
    const r = compareRows(a,b,sortState.key);
    if (r !== 0) return r;
    // tie-breaker: updated desc
    const av = a.updatedAtRaw ? new Date(a.updatedAtRaw).getTime() : 0;
    const bv = b.updatedAtRaw ? new Date(b.updatedAtRaw).getTime() : 0;
    return (bv - av);
  });
  return arr;
}

function updateSortIcons(){
  document.querySelectorAll('#resTable thead th.sortable').forEach(th=>{
    const k = th.getAttribute('data-sort');
    const s = th.querySelector('.s');
    th.classList.toggle('active', sortState.key === k);
    if (!s) return;
    if (sortState.key !== k){ s.textContent = '‚Üï'; return; }
    s.textContent = sortState.dir === 1 ? '‚ñ≤' : '‚ñº';
  });
}

/* ---------- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ---------- */
function updateStats(rows){
  const statsBox = document.getElementById('statsInfo');
  if (!rows.length){ statsBox.style.display='none'; return; }
  const nums = rows.map(r=>r.distance_km).filter(Number.isFinite);
  if (!nums.length){ statsBox.style.display='none'; return; }
  const max = Math.max(...nums), min = Math.min(...nums), avg = nums.reduce((a,b)=>a+b,0)/nums.length;
  document.getElementById('statMax').textContent = `–ù–∞–π–±—ñ–ª—å—à–∞: ${max.toFixed(3)}`;
  document.getElementById('statMin').textContent = `–ù–∞–π–º–µ–Ω—à–∞: ${min.toFixed(3)}`;
  document.getElementById('statAvg').textContent = `–°–µ—Ä–µ–¥–Ω—è: ${avg.toFixed(3)}`;
  statsBox.style.display='';
}

/* ---------- –ù–∞–≤—ñ–≥–∞—Ç–æ—Ä ---------- */
async function buildNavigatePayloadById(routeId, prettyName){
  const ref = db.collection('routes').doc(routeId);
  const doc = await ref.get();
  if (!doc.exists) throw new Error('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
  const d = doc.data() || {};

  let points =
      normalizePoints(d.points) ||
      normalizePoints(d.coordinates) ||
      normalizePoints(d.route) ||
      normalizePoints(d.geojson) ||
      normalizePoints(d.geometry);

  if (!points) {
    const parts = [];
    if (d.start) { const p = toLonLat(d.start); if (p) parts.push(p); }
    if (Array.isArray(d.midpoints)) for (const m of d.midpoints){ const p=toLonLat(m); if (p) parts.push(p); }
    if (d.end) { const p = toLonLat(d.end); if (p) parts.push(p); }
    if (parts.length >= 2) points = parts;
  }
  if (!points || points.length < 2) throw new Error('–£ –º–∞—Ä—à—Ä—É—Ç—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –º–∞—Å–∏–≤ —Ç–æ—á–æ–∫');

  const manualSegments = normalizeSegments(d);
  return { name: prettyName || '–ú–∞—Ä—à—Ä—É—Ç', points: roundCoords(points), manualSegments: (manualSegments || []).map(roundCoords) };
}

function buildNavigateURLFromPayload(payloadObj){
  const base = `${location.origin}${NAVIGATE_PAGE}`;
  const q = new URLSearchParams();
  try { const json = JSON.stringify(payloadObj); const srcz = LZString.compressToEncodedURIComponent(json); q.set('srcz', srcz); } catch(e){ console.warn('Compression failed:', e); }
  try { q.set('src', b64encodeUtf8(payloadObj)); } catch(e){}
  return `${base}?${q.toString()}`;
}

function isMobileUA(){ return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent || ''); }
async function shareURL(url, title){
  if (isMobileUA() && navigator.share){ try { await navigator.share({ title: title || '–ú–∞—Ä—à—Ä—É—Ç', url }); return; } catch{} }
  try { await navigator.clipboard.writeText(url); alert('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ —É –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É!'); }
  catch { prompt('–°–∫–æ–ø—ñ—é–π—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –≤—Ä—É—á–Ω—É:', url); }
}

/* ---------- –¢–∞–±–ª–∏—Ü—è ---------- */
function renderTable(rows){
  const tb = document.querySelector('#resTable tbody');
  tb.innerHTML = rows.map(r=>`<tr data-id="${r.id}">
    <td class="cell-code" title="${r.fromCode}">${r.fromCode}</td>
    <td class="cell-code" title="${r.toCode}">${r.toCode}</td>
    <td>${r.fromName}</td>
    <td>${r.toName}</td>
    <td>${Number.isFinite(r.distance_km) ? r.distance_km.toFixed(3) : ''}</td>
    <td>${r.type}</td>
    <td>${r.logisticName || ''}</td>
    <td>${r.updatedAt}</td>
    <td class="cell-key" title="${r.routeKey || ''}">
      ${r.routeKey || ''}
      ${r.routeKey ? `<button class="copy-btn copy-key" data-val="${r.routeKey}" title="–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∫–æ–¥">üìã</button>` : ''}
    </td>
    <td class="cell-id" title="${r.id}">
      ${r.id}
      <button class="copy-btn copy-id" data-val="${r.id}" title="–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ ID">üìã</button>
    </td>
    <td><a href="${MAP_URL}?rid=${encodeURIComponent(r.id)}" target="_blank" rel="noopener">–í—ñ–¥–∫—Ä–∏—Ç–∏</a></td>
    <td><button class="btn sm share-btn" data-id="${r.id}" data-name="${(r.fromName||'') + ' ‚Üí ' + (r.toName||'')}">üîó –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è</button></td>
  </tr>`).join('');
  document.getElementById('countInfo').textContent = `–ó–∞–ø–∏—Å—ñ–≤ (–ø—ñ—Å–ª—è —Ñ—ñ–ª—å—Ç—Ä—É): ${rows.length}`;
  updateStats(rows);
}

/* ---------- –ï–∫—Å–ø–æ—Ä—Ç —É Excel (–∫–ª—ñ–∫–∞–±–µ–ª—å–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è + –∞–≤—Ç–æ—Ñ—ñ–ª—å—Ç—Ä) ---------- */
function exportToExcel(rows){
  const header = ['–ö–æ–¥ –í—ñ–¥','–ö–æ–¥ –î–æ','–í—ñ–¥','–î–æ','–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º','–¢–∏–ø','–õ–æ–≥—ñ—Å—Ç','–û–Ω–æ–≤–ª–µ–Ω–æ','–ö–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É','ID','URL (–ö–∞—Ä—Ç–∞)'];

  const body = rows.map(r => {
    const mapUrl = `${location.origin}${MAP_URL}?rid=${encodeURIComponent(r.id)}`;
    return [
      r.fromCode, r.toCode, r.fromName, r.toName,
      Number.isFinite(r.distance_km) ? Number(r.distance_km.toFixed(3)) : '',
      r.type, r.logisticName || '', r.updatedAt, r.routeKey || '', r.id,
      { t: 's', v: 'üó∫Ô∏è –í—ñ–¥–∫—Ä–∏—Ç–∏', l: { Target: mapUrl, Tooltip: '–í—ñ–¥–∫—Ä–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –Ω–∞ –∫–∞—Ä—Ç—ñ' } }
    ];
  });

  const ws = XLSX.utils.aoa_to_sheet([header, ...body]);
  ws['!cols'] = [12,12,28,28,12,16,22,22,18,36,18].map(w => ({ wch: w }));
  ws['!autofilter'] = { ref: XLSX.utils.encode_range({ s:{c:0,r:0}, e:{c:10,r:body.length} }) };

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '–ú–∞—Ä—à—Ä—É—Ç–∏');
  XLSX.writeFile(wb, 'routes_export.xlsx');
}

/* ---------- UI –¥–æ–ø–æ–º—ñ–∂–Ω–µ ---------- */
function updatePagerUI(){
  const moreBox = document.getElementById('moreBox');
  moreBox.style.display = allRows.length ? '' : 'none';
  btnMore.style.display = _hasMore ? '' : 'none';
  btnAll.style.display  = _hasMore ? '' : 'none';
}

/* ---------- –û–Ω–æ–≤–∏—Ç–∏ –±–∞–∑—É (—Ñ–æ—Ä—Å —ñ–∑ —Å–µ—Ä–≤–µ—Ä–∞) ---------- */
async function refreshAll(){
  try{
    setBusy(true);
    try{ localStorage.removeItem(DIR_CACHE_KEY); }catch{}
    try{ localStorage.removeItem(LOGISTS_CACHE_KEY); }catch{}
    await Promise.all([loadDirectory(true), loadLogists(true)]);
    await loadFirstPage(true);
    reRender();
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
}

/* ---------- –ü–æ–º–∏–ª–∫–∏ Firestore ---------- */
function handleFirestoreError(e){
  console.error('Firestore error:', e);
  const msg = e?.message || '';
  if (e?.code === 'failed-precondition' && msg.includes('create it here')) {
    const m = msg.match(/https:\/\/console\.firebase\.google\.com\/[^\s"]+/);
    if (m && m[0]) { const url = m[0]; try { window.open(url, '_blank'); } catch(_) {} alert('–î–ª—è —Ü—å–æ–≥–æ –∑–∞–ø–∏—Ç—É –ø–æ—Ç—Ä—ñ–±–µ–Ω —ñ–Ω–¥–µ–∫—Å —É Firestore.\n–Ø –≤—ñ–¥–∫—Ä–∏–≤ —Å—Ç–æ—Ä—ñ–Ω–∫—É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—É —É –Ω–æ–≤—ñ–π –≤–∫–ª–∞–¥—Ü—ñ.\n\n–ü–æ—Å–∏–ª–∞–Ω–Ω—è:\n' + url); return; }
  }
  alert(msg || e);
}

/* ---------- –†–µ–Ω–¥–µ—Ä (–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ —ñ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è) ---------- */
function reRender(){
  let rows = applyTopFilters(allRows);
  rows = applyTableFilters(rows);
  rows = sortRows(rows);
  renderTable(rows);
  updatePagerUI();
  updateSortIcons();
}

/* ---------- –ü–æ–¥—ñ—ó ---------- */
btnPreview.addEventListener('click', async ()=>{
  try{
    setBusy(true);
    await loadFirstPage(false);
    reRender();
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

btnMore.addEventListener('click', async ()=>{
  try{
    setBusy(true);
    await loadNextPage();
    reRender();
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

btnAll.addEventListener('click', async ()=>{
  try{
    setBusy(true);
    const MAX_ROWS = 50000; // –∑–∞–ø–æ–±—ñ–∂–Ω–∏–∫
    while(_hasMore && allRows.length < MAX_ROWS){ await loadNextPage(); }
    reRender();
    if (_hasMore) alert(`–î–æ—Å—è–≥–Ω—É—Ç–æ –ª—ñ–º—ñ—Ç ${MAX_ROWS.toLocaleString()} —Ä—è–¥–∫—ñ–≤. –ó–≤—É–∑—å—Ç–µ —Ñ—ñ–ª—å—Ç—Ä–∏ –∞–±–æ –µ–∫—Å–ø–æ—Ä—Ç—É–π—Ç–µ —á–∞—Å—Ç–∏–Ω–∞–º–∏.`);
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

btnExport.addEventListener('click', async ()=>{
  try{
    setBusy(true);
    if (!allRows.length){ await loadFirstPage(false); }
    if (_hasMore){
      const agree = confirm(`–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –í–°–Ü —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ø–µ—Ä–µ–¥ –µ–∫—Å–ø–æ—Ä—Ç–æ–º? –ó–∞—Ä–∞–∑ —É –ø–∞–º'—è—Ç—ñ ${allRows.length}+ —Ä—è–¥–∫—ñ–≤.`);
      if (agree){
        const MAX_ROWS = 50000;
        while(_hasMore && allRows.length < MAX_ROWS){ await loadNextPage(); }
        if (_hasMore) alert(`–î–æ—Å—è–≥–Ω—É—Ç–æ –ª—ñ–º—ñ—Ç ${MAX_ROWS.toLocaleString()} —Ä—è–¥–∫—ñ–≤. –ï–∫—Å–ø–æ—Ä—Ç –ø–æ –ø–µ—Ä—à–∏—Ö ${MAX_ROWS.toLocaleString()}.`);
      }
    }
    let rows = applyTopFilters(allRows);
    rows = applyTableFilters(rows);
    rows = sortRows(rows);
    exportToExcel(rows);
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

btnRefresh.addEventListener('click', refreshAll);

document.querySelector('#resTable thead').addEventListener('click', (ev)=>{
  const th = ev.target.closest('th.sortable');
  if (!th) return;
  const key = th.getAttribute('data-sort');
  if (sortState.key === key) sortState.dir *= -1;
  else { sortState.key = key; sortState.dir = 1; }
  reRender();
});

function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
const onFilterChange = debounce(()=> reRender(), 200);
document.querySelector('#resTable thead').addEventListener('input', onFilterChange);
btnClearFilters.addEventListener('click', ()=>{
  document.querySelectorAll('#resTable thead .filters input, #resTable thead .filters select')
    .forEach(el=>{ el.value=''; });
  reRender();
});

/* –î–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è –∫–ª—ñ–∫—ñ–≤: –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è + –ö–æ–ø—ñ—é–≤–∞—Ç–∏ ID/–ö–æ–¥ */
document.querySelector('#resTable tbody').addEventListener('click', async (ev)=>{
  const shareBtn = ev.target.closest('.share-btn');
  if (shareBtn){
    const id = shareBtn.getAttribute('data-id');
    const prettyName = shareBtn.getAttribute('data-name') || '–ú–∞—Ä—à—Ä—É—Ç';
    try{
      setBusy(true);
      const payload = await buildNavigatePayloadById(id, prettyName);
      const url = buildNavigateURLFromPayload(payload);
      await shareURL(url, prettyName);
    }catch(e){ alert('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –Ω–∞–≤—ñ–≥–∞—Ç–æ—Ä–∞: ' + (e?.message || e)); }
    finally{ setBusy(false); }
    return;
  }

  const copyBtn = ev.target.closest('.copy-btn');
  if (copyBtn){
    const val = copyBtn.getAttribute('data-val') || '';
    try{
      await navigator.clipboard.writeText(val);
      copyBtn.textContent = '‚úÖ';
      setTimeout(()=>{ copyBtn.textContent = 'üìã'; }, 1000);
    }catch{ prompt('–°–∫–æ–ø—ñ—é–π—Ç–µ –∑–Ω–∞—á–µ–Ω–Ω—è –≤—Ä—É—á–Ω—É:', val); }
  }
});

/* ---------- –°—Ç–∞—Ä—Ç ---------- */
(async ()=>{
  if (!db) return;
  statusEl.textContent = '–£–≤—ñ–π–¥—ñ—Ç—å';
  if (auth?.currentUser) { await Promise.all([loadDirectory(), loadLogists(true)]); }
})();

/* ============================================================
   –û–†–ò–ì–Ü–ù–ê–õ–¨–ù–ò–ô –ö–û–î –ú–ê–†–®–†–£–¢–£ (–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä routeKey)
   –ü—Ä–∏–∫–ª–∞–¥: –ì–∞–π—Å–∏–Ω ‚Üí –¢—Ä–æ—â–∞ => "–ì-–¢-XXXXXXXXXX"
   ============================================================ */
function _firstLetter(s){
  const t = String(s||'').trim();
  return t ? t[0].toUpperCase() : 'X';
}
async function mintRouteKey(fromName, toName){
  const prefix = `${_firstLetter(fromName)}-${_firstLetter(toName)}-`;
  while(true){
    const rnd = Math.floor(Math.random() * 1e10).toString().padStart(10,'0'); // 10 —Ü–∏—Ñ—Ä
    const key = prefix + rnd;
    const ref = db.collection('routeKeys').doc(key);
    try{
      await db.runTransaction(async tx=>{
        const snap = await tx.get(ref);
        if (snap.exists) throw new Error('exists');
        tx.set(ref, { createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      });
      return key;
    }catch(e){
      if (e.message !== 'exists') console.warn('mintRouteKey retry:', e.message||e);
    }
  }
}
</script>
</body>
</html>
